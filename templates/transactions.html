{% extends "base.html" %}

{% block title %}Transactions - {{ customer.name }}{% endblock %}

{% block content %}

<div class="container">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">

                <div>
                    <h1><i class="fas fa-exchange-alt me-2"></i>Transactions</h1>
                    <p class="text-muted">Customer: {{ customer.name }} ({{ customer.icl_no }})</p>
                {% if transactions|length > 0 %}
                    {% if current_user.role == 'admin' and not customer.loan_closed %}
                        {% set balance_for_closure = customer.get_current_balance() %}
                            {% if balance_for_closure <= 10.00 %}
                                    <form method="POST" action="{{ url_for('close_loan', customer_id=customer.id) }}" class="d-inline" 
                                        onsubmit="return confirm('Are you sure you want to  close this loan? Current balance: {{ balance_for_closure | safe_currency }}. This action cannot be undone.')">
                                        <button type="submit" class="btn btn-warning btn-sm">
                                            <i class="fas fa-lock me-1"></i>Mark this loan as closed
                                        </button>
                                    </form>
                            {% else %}
                                    <span class="text-muted small">
                                        <i class="fas fa-info-circle me-1"></i>Balance must be ≤ ₹10.00 to close manually (Current: {{ balance_for_closure | safe_currency }})
                                    </span>
                    {% endif %}
                {% endif %}
                {% endif %}
                    {% if customer.loan_closed %}
                    <div class="alert alert-danger">
                        <i class="fas fa-lock me-2"></i>
                        <strong>Loan Closed:</strong> This loan was closed on {{ customer.loan_closed_date.strftime('%d-%m-%Y') if customer.loan_closed_date else 'N/A' }}. No new transactions can be added.
                    </div>
                    {% endif %}
                </div>
                <div>
                    <span class="badge bg-primary fs-6">Current Balance: {{ customer.get_current_balance() | safe_currency }}</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Transaction Form -->
    {% if current_user.role in ['admin', 'data_entry'] and not customer.loan_closed %}
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-plus me-2"></i>Add New Transaction</h5>
                    </div>
                    <div class="card-body">
                    <form method="POST" id="transactionForm">
                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="date" class="form-label">Transaction Date <span class="text-danger">*</span></label>
                                    <input type="date" class="form-control" id="date" name="date" 
                                           {% if customer.icl_end_date %}max="{{ customer.icl_end_date.strftime('%Y-%m-%d') }}"{% endif %}
                                           required>
                                    {% if customer.icl_end_date %}
                                    <small class="text-muted">Max date: {{ customer.icl_end_date.strftime('%d-%m-%Y') }}</small>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label for="amount_paid" class="form-label">Amount Paid (₹)</label>
                                    <input type="number" class="form-control" id="amount_paid" name="amount_paid" 
                                           step="0.01" min="0" placeholder="0.00">
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label for="amount_repaid" class="form-label">Amount Repaid (₹)</label>
                                    <input type="number" class="form-control" id="amount_repaid" name="amount_repaid" 
                                           step="0.01" min="0" placeholder="0.00">
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label class="form-label">Current Balance</label>
                                    <input type="text" class="form-control" id="current_balance_display" 
                                           value="{{ customer.get_current_balance() | safe_currency }}" readonly>
                                </div>
                            </div>
                        </div>

                        <hr>

                        <h6><i class="fas fa-percent me-2"></i>Interest Calculation Period</h6>
                        <div class="row">
                            <div class="col-12">
                                <div class="alert alert-info">
                                    <i class="fas fa-info-circle"></i>
                                    Period dates are automatically calculated based on interest type and transaction history.
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Interest Rate</label>
                                    <input type="text" class="form-control" 
                                           value="{{ customer.annual_rate | safe_percentage }}" readonly>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Interest Type</label>
                                    <input type="text" class="form-control" 
                                           value="{{ customer.interest_type.title() }}" readonly>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">TDS Applicable</label>
                                    <input type="text" class="form-control" 
                                           value="{% if customer.tds_applicable %}Yes{% else %}No{% endif %}" readonly>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">TDS Rate</label>
                                    <input type="text" class="form-control" 
                                           value="{{ customer.tds_percentage | safe_percentage }}" readonly>
                                </div>
                            </div>
                        </div>

                        <div class="text-center">
                            <button type="submit" class="btn btn-success">
                                <i class="fas fa-save me-2"></i>Add Transaction
                            </button>
                            <button type="reset" class="btn btn-secondary">
                                <i class="fas fa-undo me-2"></i>Reset
                            </button>
                            <a href="{{ url_for('customer_profile', customer_id=customer.id) }}" class="btn btn-outline-primary">
                                <i class="fas fa-arrow-left me-2"></i>Back to Profile
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    {% endif %}
    <!-- Edit Transaction Modal -->
<div class="modal fade" id="editTransactionModal" tabindex="-1" aria-labelledby="editTransactionModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editTransactionModalLabel">Edit Transaction</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form method="POST" id="editTransactionForm">
                    <!-- Hidden input for transaction ID -->
                    <input type="hidden" id="edit_transaction_id" name="transaction_id">
                    <div class="mb-3">
                        <label for="edit_date" class="form-label">Transaction Date <span class="text-danger">*</span></label>
                        <input type="date" class="form-control" id="edit_date" name="date" required>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="edit_amount_paid" class="form-label">Amount Paid (Deposit)</label>
                                <input type="number" class="form-control" id="edit_amount_paid" name="amount_paid" step="0.01" min="0">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="edit_amount_repaid" class="form-label">Amount Repaid (Withdrawal)</label>
                                <input type="number" class="form-control" id="edit_amount_repaid" name="amount_repaid" step="0.01" min="0">
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="edit_period_from" class="form-label">Interest Period From</label>
                                <input type="date" class="form-control" id="edit_period_from" name="period_from">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="edit_period_to" class="form-label">Interest Period To</label>
                                <input type="date" class="form-control" id="edit_period_to" name="period_to">
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" form="editTransactionForm" class="btn btn-primary">Save Changes</button>
            </div>
        </div>
    </div>
</div>

    <!-- Transaction History -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-history me-2"></i>Transaction History</h5>
                </div>
                <div class="card-body">
                    {% if transactions %}
                    <div class="table-responsive">
                        <table class="table table-striped table-hover" id="transactionsTable">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Type</th>
                                    <th>Amount Paid</th>
                                    <th>Amount Repaid</th>
                                    <th>Balance</th>
                                    <th>Period From</th>
                                    <th>Period To</th>
                                    <th>Days</th>
                                    <th>Interest Rate</th>
                                    <th>Interest Amount</th>
                                    <th>TDS</th>
                                    <th>Net Amount</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for transaction in transactions %}
                                    <tr {% if transaction.transaction_type == 'loan_closure' %}class="table-success"{% endif %}>
                                        <td>
                                            {{ transaction.date.strftime('%d-%m-%Y') if transaction.date else '-' }}
                                            {% if transaction.transaction_type == 'loan_closure' %}
                                                <span class="badge bg-success ms-2">LOAN CLOSED</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <span class="badge bg-{% if transaction.transaction_type == 'deposit' %}success{% elif transaction.transaction_type == 'repayment' %}warning{% elif transaction.transaction_type == 'loan_closure' %}danger{% else %}secondary{% endif %}">
                                                {{ transaction.get_transaction_type_display() }}
                                            </span>
                                        </td>
                                        <td class="text-end">
                                            {% if transaction.transaction_type == 'loan_closure' %}
                                                <span class="text-muted">-</span>
                                            {% elif transaction.amount_paid %}
                                                <span class="text-success">{{ transaction.amount_paid | safe_currency }}</span>
                                            {% else %}
                                                <span class="text-muted">-</span>
                                            {% endif %}
                                        </td>
                                        <td class="text-end">
                                            {% if transaction.transaction_type == 'loan_closure' %}
                                                {% set repayment_txn = transactions | selectattr('date', 'equalto', transaction.date) | selectattr('transaction_type', 'equalto', 'repayment') | first %}
                                                {% if repayment_txn and repayment_txn.amount_repaid %}
                                                    <span class="text-danger">{{ repayment_txn.amount_repaid | safe_currency }}</span>
                                                {% else %}
                                                    <span class="text-muted">-</span>
                                                {% endif %}
                                            {% elif transaction.amount_repaid %}
                                                <span class="text-danger">{{ transaction.amount_repaid | safe_currency }}</span>
                                            {% else %}
                                                <span class="text-muted">-</span>
                                            {% endif %}
                                        </td>
                                        <td class="text-end">
                                            {% if transaction.transaction_type == 'loan_closure' %}
                                                {{ "0.00" | safe_currency }}
                                            {% else %}
                                                {{ transaction.balance | safe_currency }}
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if transaction.transaction_type == 'loan_closure' %}
                                                -
                                            {% else %}
                                                {{ transaction.period_from.strftime('%d-%m-%Y') if transaction.period_from else '-' }}
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if transaction.transaction_type == 'loan_closure' %}
                                                -
                                            {% else %}
                                                {{ transaction.period_to.strftime('%d-%m-%Y') if transaction.period_to else '-' }}
                                            {% endif %}
                                        </td>
                                        <td class="text-center">
                                            {% if transaction.transaction_type == 'loan_closure' %}
                                                -
                                            {% else %}
                                                {{ transaction.no_of_days if transaction.no_of_days else '-' }}
                                            {% endif %}
                                        </td>
                                        <td class="text-center">
                                            {% if transaction.transaction_type == 'loan_closure' %}
                                                -
                                            {% else %}
                                                {{ transaction.int_rate | safe_percentage if transaction.int_rate else '-' }}
                                            {% endif %}
                                        </td>
                                        <td class="text-end">
                                            {% if transaction.transaction_type == 'loan_closure' %}
                                                -
                                            {% else %}
                                                {{ transaction.int_amount | safe_currency if transaction.int_amount else '-' }}
                                            {% endif %}
                                        </td>
                                        <td class="text-end">
                                            {% if transaction.transaction_type == 'loan_closure' %}
                                                -
                                            {% else %}
                                                {{ transaction.tds_amount | safe_currency if transaction.tds_amount else '-' }}
                                            {% endif %}
                                        </td>
                                        <td class="text-end">
                                            {% if transaction.transaction_type == 'loan_closure' %}
                                                -
                                            {% else %}
                                                {{ transaction.net_amount | safe_currency if transaction.net_amount else '-' }}
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if current_user.role in ['admin', 'data_entry'] and transaction.transaction_type != 'loan_closure' %}
                                                <div class="btn-group btn-group-sm" role="group">
                                                    <button class="btn btn-outline-primary edit-transaction-btn" 
                                                            data-transaction-id="{{ transaction.id }}"
                                                            data-date="{{ transaction.date.strftime('%Y-%m-%d') if transaction.date }}"
                                                            data-amount-paid="{{ transaction.amount_paid if transaction.amount_paid else '' }}"
                                                            data-amount-repaid="{{ transaction.amount_repaid if transaction.amount_repaid else '' }}"
                                                            data-period-from="{{ transaction.period_from.strftime('%Y-%m-%d') if transaction.period_from }}"
                                                            data-period-to="{{ transaction.period_to.strftime('%Y-%m-%d') if transaction.period_to }}"
                                                            data-bs-toggle="modal" 
                                                            data-bs-target="#editTransactionModal"
                                                            title="Edit Transaction">
                                                        <i class="fas fa-edit"></i>
                                                    </button>
                                                    {% if current_user.role == 'admin' %}
                                                    <button class="btn btn-outline-danger" 
                                                            onclick="confirmDeleteTransaction({{ transaction.id }}, '{{ transaction.date.strftime('%d-%m-%Y') if transaction.date }}')"
                                                            title="Delete Transaction">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                    {% endif %}
                                                </div>
                                            {% else %}
                                                -
                                            {% endif %}
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    <!-- Transaction Summary Section -->
                    {% if transactions %}
                    <div class="mt-4">
                        <div class="card border-primary">
                            <div class="card-header bg-primary text-white">
                                <h6 class="mb-0"><i class="fas fa-calculator me-2"></i>Transaction Totals Summary</h6>
                            </div>
                            <div class="card-body">
                                <div class="row text-center">
                                    <div class="col-md-3">
                                        <div class="border-end">
                                            <h5 class="text-info mb-1" id="totalInterest">
                                                {% set total_interest = transactions | selectattr('int_amount', 'defined') | selectattr('int_amount', 'ne', none) | sum(attribute='int_amount') | default(0, true) %}
                                                {{ total_interest | safe_currency }}
                                            </h5>
                                            <small class="text-muted">Total Interest Amount</small>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="border-end">
                                            <h5 class="text-warning mb-1" id="totalTds">
                                                {% set total_tds = transactions | selectattr('tds_amount', 'defined') | selectattr('tds_amount', 'ne', none) | sum(attribute='tds_amount') | default(0, true) %}
                                                {{ total_tds | safe_currency }}
                                            </h5>
                                            <small class="text-muted">Total TDS Amount</small>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="border-end">
                                            <h5 class="text-success mb-1" id="totalNet">
                                                {% set total_net = transactions | selectattr('net_amount', 'defined') | selectattr('net_amount', 'ne', none) | sum(attribute='net_amount') | default(0, true) %}
                                                {{ total_net | safe_currency }}
                                            </h5>
                                            <small class="text-muted">Total Net Amount</small>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <h5 class="text-primary mb-1" id="totalTransactions">
                                            {{ transactions | length }}
                                        </h5>
                                        <small class="text-muted">Total Transactions</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">No transactions found</h5>
                        <p class="text-muted">Add the first transaction using the form above.</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
$(document).ready(function() {
    const transactionDateInput = $('#date');
    const periodFromInput = $('#period_from');
    const periodToInput = $('#period_to');

    // Set today's date as default for Transaction Date if not already set
    const today = new Date().toISOString().split('T')[0];
    if (!transactionDateInput.val()) {
        transactionDateInput.val(today);
    }

    // Set initial Period From using the value passed from Flask
    // This ensures JS controls the initial value and can be more resilient
    const defaultPeriodFromValue = "{{ default_period_from }}";
    if (defaultPeriodFromValue) {
        periodFromInput.val(defaultPeriodFromValue);
        console.log('Initial Period From set to:', periodFromInput.val());
    }

    // Period To always mirrors Transaction Date
    periodToInput.val(transactionDateInput.val()); // Initial set
    transactionDateInput.on('change', function() {
        periodToInput.val($(this).val()); // Update when transaction date changes
        console.log('Period To updated to:', periodToInput.val(), 'due to Transaction Date change.');
    });

    // Add a change listener to Period From for debugging purposes
    periodFromInput.on('change', function() {
        console.log('User manually changed Period From to:', $(this).val());
    });

    // Initialize DataTable with proper cleanup
    const $transactionTable = $('#transactionsTable');
    if ($transactionTable.length && !$.fn.DataTable.isDataTable($transactionTable)) {
        try {
            const table = $transactionTable.DataTable({
                "destroy": true,
                "pageLength": 10,
                "responsive": true,
                "order": [[0, "desc"]], // Sort by date descending
                "language": {
                    "search": "Search transactions:"
                },
                "drawCallback": function(settings) {
                    updateTransactionTotals();
                }
            });
            console.log('Transaction DataTable initialized successfully');
            
            // Initial calculation
            updateTransactionTotals();
        } catch (error) {
            console.error('Failed to initialize transaction DataTable:', error);
        }
    }

    // Function to update transaction totals based on visible rows
    function updateTransactionTotals() {
        if (!$.fn.DataTable.isDataTable('#transactionsTable')) return;
        
        const table = $('#transactionsTable').DataTable();
        const visibleData = table.rows({ search: 'applied' }).data();
        
        let totalInterest = 0;
        let totalTds = 0;
        let totalNet = 0;
        let transactionCount = 0;
        
        for (let i = 0; i < visibleData.length; i++) {
            const row = visibleData[i];
            // Skip loan closure transactions
            if ($(table.row(i).node()).hasClass('table-success')) continue;
            
            transactionCount++;
            
            // Extract numeric values from currency formatted cells
            const interestCell = $(table.cell(i, 9).node()).text().replace(/[₹,\s-]/g, '');
            const tdsCell = $(table.cell(i, 10).node()).text().replace(/[₹,\s-]/g, '');
            const netCell = $(table.cell(i, 11).node()).text().replace(/[₹,\s-]/g, '');
            
            if (interestCell && !isNaN(parseFloat(interestCell))) {
                totalInterest += parseFloat(interestCell);
            }
            if (tdsCell && !isNaN(parseFloat(tdsCell))) {
                totalTds += parseFloat(tdsCell);
            }
            if (netCell && !isNaN(parseFloat(netCell))) {
                totalNet += parseFloat(netCell);
            }
        }
        
        // Update the summary section
        $('#totalInterest').text('₹' + totalInterest.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2}));
        $('#totalTds').text('₹' + totalTds.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2}));
        $('#totalNet').text('₹' + totalNet.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2}));
        $('#totalTransactions').text(transactionCount);
    }

    // Form validation (client-side)
    $('#transactionForm').submit(function(e) {
        var amountPaid = parseFloat($('#amount_paid').val()) || 0;
        var amountRepaid = parseFloat($('#amount_repaid').val()) || 0;

      /*  if (amountPaid === 0 && amountRepaid === 0) {
            e.preventDefault();
            if (typeof LoanApp !== 'undefined' && LoanApp.utils && LoanApp.utils.showInputError) {
                LoanApp.utils.showInputError($('#amount_paid')[0], 'Please enter either amount paid or amount repaid.');
                LoanApp.utils.showInputError($('#amount_repaid')[0], 'Please enter either amount paid or amount repaid.');
            } else {
                alert('Please enter either amount paid or amount repaid.');
            }
            return false;
        }*/

        // Validate period_from <= period_to if manually changed
        var fromDate = periodFromInput.val();
        var toDate = periodToInput.val();

        if (fromDate && toDate && new Date(fromDate) > new Date(toDate)) {
            e.preventDefault();
            if (typeof LoanApp !== 'undefined' && LoanApp.utils && LoanApp.utils.showInputError) {
                LoanApp.utils.showInputError(periodToInput[0], 'Period from date cannot be later than period to date.');
            } else {
                alert('Period from date cannot be later than period to date.');
            }
            return false;
        }
    });

    // Update balance display on amount changes
    $('#amount_paid, #amount_repaid').on('input', function() {
        // This is client-side projection, actual balance will be calculated server-side
        var initialCustomerBalance = {{ customer.get_current_balance() | safe_decimal }};
        var amountPaid = parseFloat($('#amount_paid').val()) || 0;
        var amountRepaid = parseFloat($('#amount_repaid').val()) || 0;

        // This projection does NOT include interest/tds for the new transaction,
        // as that is complex and handled fully on the server.
        // It only reflects the principal movement.
        var newProjectedBalance = initialCustomerBalance + amountPaid - amountRepaid;
        $('#current_balance_display').val('₹' + newProjectedBalance.toFixed(2));
    });

    // Edit Transaction Modal Logic
    const editTransactionForm = document.getElementById('editTransactionForm');

    document.querySelectorAll('.edit-transaction-btn').forEach(button => {
        button.addEventListener('click', function() {
            const transactionId = this.dataset.transactionId;
            const transactionDate = this.dataset.date;
            const amountPaid = this.dataset.amountPaid;
            const amountRepaid = this.dataset.amountRepaid;
            const periodFrom = this.dataset.periodFrom;
            const periodTo = this.dataset.periodTo;

            // Set form action dynamically
            editTransactionForm.action = `/edit_transaction/${transactionId}`;

            // Populate form fields
            document.getElementById('edit_transaction_id').value = transactionId;
            document.getElementById('edit_date').value = transactionDate;
            document.getElementById('edit_amount_paid').value = amountPaid;
            document.getElementById('edit_amount_repaid').value = amountRepaid;
            document.getElementById('edit_period_from').value = periodFrom;
            document.getElementById('edit_period_to').value = periodTo;

            // For edit modal, period_from and period_to are still editable by admin
            // No automation for these fields in edit modal, as admin might need to correct.
        });
    });

    // Calculate days when dates are selected for EDIT transaction form (still manual for edit)
    $('#edit_period_from, #edit_period_to').change(function() {
        var fromDate = $('#edit_period_from').val();
        var toDate = $('#edit_period_to').val();

        if (fromDate && toDate) {
            var from = new Date(fromDate);
            var to = new Date(toDate);
            var diffTime = Math.abs(to - from);
            var diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

            console.log('Edit Form Days calculated:', diffDays);
        }
    });
    function confirmLoanClose(customerId, customerName) {
        if (confirm(`Are you sure you want to close the loan for "${customerName}"? This action will mark the loan as closed and prevent further transactions.`)) {
            // Create a form to submit the close loan request
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = `/customer/${customerId}/close_loan`;

            // Add CSRF token if needed
            const csrfToken = document.querySelector('meta[name=csrf-token]');
            if (csrfToken) {
                const csrfInput = document.createElement('input');
                csrfInput.type = 'hidden';
                csrfInput.name = 'csrf_token';
                csrfInput.value = csrfToken.getAttribute('content');
                form.appendChild(csrfInput);
            }

            document.body.appendChild(form);
            form.submit();
        }
    }
    // Form validation for EDIT transaction form
    $('#editTransactionForm').submit(function(e) {
        var amountPaid = parseFloat($('#edit_amount_paid').val()) || 0;
        var amountRepaid = parseFloat($('#edit_amount_repaid').val()) || 0;

      /*  if (amountPaid === 0 && amountRepaid === 0) {
            e.preventDefault();
            if (typeof LoanApp !== 'undefined' && LoanApp.utils && LoanApp.utils.showInputError) {
                LoanApp.utils.showInputError($('#edit_amount_paid')[0], 'Please enter either amount paid or amount repaid.');
                LoanApp.utils.showInputError($('#edit_amount_repaid')[0], 'Please enter either amount paid or amount repaid.');
            } else {
                alert('Please enter either amount paid or amount repaid.');
            }
            return false;
        }*/

        var fromDate = $('#edit_period_from').val();
        var toDate = $('#edit_period_to').val();

        if ((fromDate && !toDate) || (!fromDate && toDate)) {
            e.preventDefault();
            if (typeof LoanApp !== 'undefined' && LoanApp.utils && LoanApp.utils.showInputError) {
                LoanApp.utils.showInputError($('#edit_period_to')[0], 'Please select both period from and period to dates, or leave both empty.');
            } else {
                alert('Please select both period from and period to dates, or leave both empty.');
            }
            return false;
        }

        if (fromDate && toDate && new Date(fromDate) > new Date(toDate)) {
            e.preventDefault();
            if (typeof LoanApp !== 'undefined' && LoanApp.utils && LoanApp.utils.showInputError) {
                LoanApp.utils.showInputError($('#edit_period_to')[0], 'Period from date cannot be later than period to date.');
            } else {
                alert('Period from date cannot be later than period to date.');
            }
            return false;
        }
    });

    // Update balance display on amount changes for EDIT form (simplified projection)
    $('#edit_amount_paid, #edit_amount_repaid').on('input', function() {
        console.log('Edit Form - Projected New Balance: This is a simplified client-side projection.');
        var amountPaid = parseFloat($('#edit_amount_paid').val()) || 0;
        var amountRepaid = parseFloat($('#edit_repaid').val()) || 0;

        console.log('Edit Form - Amount Paid:', amountPaid, 'Amount Repaid:', amountRepaid);
    });

    // Confirm Delete Transaction function
    function confirmDeleteTransaction(transactionId, transactionDate) {
        if (confirm(`Are you sure you want to delete the transaction on ${transactionDate}? This action cannot be undone.`)) {
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = `/delete_transaction/${transactionId}`;
            document.body.appendChild(form);
            form.submit();
        }
    }
    // Make confirmDeleteTransaction globally accessible as it's called from onclick
    window.confirmDeleteTransaction = confirmDeleteTransaction;
});
</script>
{% endblock %}
