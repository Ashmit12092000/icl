
{% extends "base.html" %}

{% block title %}Overdue Loan Management - Account Management System{% endblock %}

{% block extra_css %}
<style>
    .overdue-card {
        border-left: 4px solid #dc3545;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .past-due-card {
        border-left: 4px solid #ffc107;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .priority-high {
        background: linear-gradient(135deg, #fff5f5 0%, #fed7d7 100%);
    }
    
    .priority-medium {
        background: linear-gradient(135deg, #fffbf0 0%, #feebc8 100%);
    }
    
    .priority-low {
        background: linear-gradient(135deg, #f0fff4 0%, #c6f6d5 100%);
    }
    
    .action-button {
        transition: all 0.3s ease;
    }
    
    .action-button:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    
    .loan-details {
        font-size: 0.9rem;
        line-height: 1.4;
    }
    
    .status-badge {
        font-weight: 600;
        padding: 0.5rem 1rem;
        border-radius: 20px;
    }
    
    .overdue-days {
        font-size: 1.2rem;
        font-weight: bold;
    }
    
    .critical-overdue {
        animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
        0% { opacity: 1; }
        50% { opacity: 0.7; }
        100% { opacity: 1; }
    }
    
    .balance-amount {
        font-size: 1.1rem;
        font-weight: 600;
    }
    
    .card-hover {
        transition: transform 0.2s ease-in-out;
    }
    
    .card-hover:hover {
        transform: translateY(-3px);
    }
    
    .quick-actions {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 1rem;
    }
    
    .filter-tabs {
        border-bottom: 2px solid #e9ecef;
        margin-bottom: 1.5rem;
    }
    
    .filter-tab {
        padding: 0.75rem 1.5rem;
        border: none;
        background: none;
        color: #6c757d;
        font-weight: 500;
        border-bottom: 3px solid transparent;
        transition: all 0.3s ease;
    }
    
    .filter-tab.active {
        color: #495057;
        border-bottom-color: #007bff;
        background: rgba(0,123,255,0.1);
    }
    
    .summary-metric {
        text-align: center;
        padding: 1.5rem;
        border-radius: 12px;
        background: white;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        margin-bottom: 1rem;
    }
    
    .metric-value {
        font-size: 2rem;
        font-weight: bold;
        margin-bottom: 0.5rem;
    }
    
    .metric-label {
        color: #6c757d;
        font-size: 0.9rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .urgency-indicator {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        display: inline-block;
        margin-right: 8px;
    }
    
    .urgency-critical { background-color: #dc3545; }
    .urgency-high { background-color: #fd7e14; }
    .urgency-medium { background-color: #ffc107; }
    .urgency-low { background-color: #28a745; }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="mb-2">
                        <i class="fas fa-exclamation-triangle me-2 text-danger"></i>
                        Overdue Loan Management
                    </h1>
                    <p class="text-muted mb-0">
                        Professional management of overdue and past-due loans with comprehensive tracking
                    </p>
                </div>
                <div class="d-flex gap-2">
                    <button class="btn btn-outline-primary" onclick="exportOverdueReport()">
                        <i class="fas fa-download me-2"></i>Export Report
                    </button>
                    <button class="btn btn-outline-secondary" onclick="refreshData()">
                        <i class="fas fa-sync-alt me-2"></i>Refresh
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Summary Dashboard -->
    <div class="row mb-4">
        <div class="col-lg-3 col-md-6">
            <div class="summary-metric">
                <div class="metric-value text-danger">{{ overdue_customers|length }}</div>
                <div class="metric-label">Marked Overdue</div>
                <small class="text-muted">Loans officially marked as overdue</small>
            </div>
        </div>
        <div class="col-lg-3 col-md-6">
            <div class="summary-metric">
                <div class="metric-value text-warning">{{ past_due_customers|length }}</div>
                <div class="metric-label">Past Due</div>
                <small class="text-muted">Awaiting action or extension</small>
            </div>
        </div>
        <div class="col-lg-3 col-md-6">
            <div class="summary-metric">
                <div class="metric-value text-info">
                    {% set total_overdue = (overdue_customers + past_due_customers) | sum(attribute='balance') %}
                    {{ total_overdue | safe_currency }}
                </div>
                <div class="metric-label">Total Outstanding</div>
                <small class="text-muted">Combined overdue amount</small>
            </div>
        </div>
        <div class="col-lg-3 col-md-6">
            <div class="summary-metric">
                <div class="metric-value text-primary">
                    {% set critical_count = 0 %}
                    {% for item in overdue_customers %}
                        {% if item.days_overdue > 90 %}
                            {% set critical_count = critical_count + 1 %}
                        {% endif %}
                    {% endfor %}
                    {{ critical_count }}
                </div>
                <div class="metric-label">Critical Cases</div>
                <small class="text-muted">Over 90 days overdue</small>
            </div>
        </div>
    </div>

    <!-- Quick Actions Panel -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="quick-actions">
                <h6 class="mb-3"><i class="fas fa-bolt me-2"></i>Quick Actions</h6>
                <div class="row">
                    <div class="col-md-6">
                        <button class="btn btn-outline-primary btn-sm w-100" onclick="exportOverdueReport()">
                            <i class="fas fa-download me-1"></i>Export Report
                        </button>
                    </div>
                    <div class="col-md-6">
                        <button class="btn btn-outline-secondary btn-sm w-100" onclick="refreshData()">
                            <i class="fas fa-sync-alt me-1"></i>Refresh Data
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Filter Tabs -->
    <div class="row mb-3">
        <div class="col-12">
            <div class="filter-tabs">
                <button class="filter-tab active" onclick="filterLoans('all')">All Cases</button>
                <button class="filter-tab" onclick="filterLoans('critical')">Critical (90+ days)</button>
                <button class="filter-tab" onclick="filterLoans('high')">High Priority (30-89 days)</button>
                <button class="filter-tab" onclick="filterLoans('medium')">Medium Priority (7-29 days)</button>
                <button class="filter-tab" onclick="filterLoans('recent')">Recent (1-6 days)</button>
            </div>
        </div>
    </div>

    <!-- Marked Overdue Loans Section -->
    {% if overdue_customers %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card overdue-card">
                <div class="card-header bg-danger text-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            Marked Overdue Loans ({{ overdue_customers|length }})
                        </h5>
                        <div class="btn-group">
                            <button class="btn btn-sm btn-outline-light" onclick="sortOverdue('days')">
                                <i class="fas fa-sort-numeric-down me-1"></i>Sort by Days
                            </button>
                            <button class="btn btn-sm btn-outline-light" onclick="sortOverdue('amount')">
                                <i class="fas fa-sort-amount-down me-1"></i>Sort by Amount
                            </button>
                        </div>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0" id="overdueTable">
                            <thead class="table-light">
                                <tr>
                                    <th>Priority</th>
                                    <th>Customer Details</th>
                                    <th>Loan Information</th>
                                    <th>Overdue Status</th>
                                    <th>Financial Impact</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in overdue_customers %}
                                {% set urgency_class = '' %}
                                {% set urgency_level = 'low' %}
                                {% if item.days_overdue > 90 %}
                                    {% set urgency_class = 'critical-overdue priority-high' %}
                                    {% set urgency_level = 'critical' %}
                                {% elif item.days_overdue > 30 %}
                                    {% set urgency_class = 'priority-medium' %}
                                    {% set urgency_level = 'high' %}
                                {% elif item.days_overdue > 7 %}
                                    {% set urgency_class = 'priority-low' %}
                                    {% set urgency_level = 'medium' %}
                                {% endif %}
                                
                                <tr class="loan-row {{ urgency_class }}" data-customer-id="{{ item.customer.id }}" data-days="{{ item.days_overdue }}" data-amount="{{ item.balance }}">
                                    <td>
                                        <span class="urgency-indicator urgency-{{ urgency_level }}"></span>
                                        <span class="badge status-badge 
                                            {% if urgency_level == 'critical' %}bg-danger
                                            {% elif urgency_level == 'high' %}bg-warning text-dark
                                            {% elif urgency_level == 'medium' %}bg-info
                                            {% else %}bg-secondary{% endif %}">
                                            {{ urgency_level.title() }}
                                        </span>
                                    </td>
                                    <td>
                                        <div class="loan-details">
                                            <strong>{{ item.customer.name }}</strong><br>
                                            <small class="text-muted">ICL: {{ item.customer.icl_no }}</small><br>
                                            {% if item.customer.contact_details %}
                                            <small class="text-info">
                                                <i class="fas fa-phone me-1"></i>{{ item.customer.contact_details }}
                                            </small>
                                            {% endif %}
                                        </div>
                                    </td>
                                    <td>
                                        <div class="loan-details">
                                            <strong>Original End:</strong> 
                                            {{ item.customer.original_icl_end_date.strftime('%d-%m-%Y') if item.customer.original_icl_end_date else item.customer.icl_end_date.strftime('%d-%m-%Y') }}<br>
                                            
                                            {% if item.customer.loan_extended %}
                                            <span class="badge bg-info">Extended</span>
                                            {% if item.customer.original_icl_end_date %}
                                            <small class="text-muted">From: {{ item.customer.original_icl_end_date.strftime('%d-%m-%Y') }}</small>
                                            {% endif %}
                                            {% endif %}
                                            
                                            <br><strong>Rate:</strong> {{ item.customer.annual_rate }}%
                                            {% if item.customer.tds_applicable %}
                                            <br><small class="text-warning">TDS: {{ item.customer.tds_percentage }}%</small>
                                            {% endif %}
                                        </div>
                                    </td>
                                    <td>
                                        <div class="text-center">
                                            <div class="overdue-days text-danger">{{ item.days_overdue }}</div>
                                            <small class="text-muted">days overdue</small>
                                            
                                            {% if item.customer.loan_overdue_date %}
                                            <br><small class="text-info">
                                                Since: {{ item.customer.loan_overdue_date.strftime('%d-%m-%Y') }}
                                            </small>
                                            {% endif %}
                                            
                                            {% if item.days_overdue > 90 %}
                                            <br><span class="badge bg-danger">CRITICAL</span>
                                            {% elif item.days_overdue > 30 %}
                                            <br><span class="badge bg-warning text-dark">HIGH RISK</span>
                                            {% endif %}
                                        </div>
                                    </td>
                                    <td>
                                        <div class="text-end">
                                            <div class="balance-amount text-danger">{{ item.balance | safe_currency }}</div>
                                            
                                            {% set daily_interest = (item.balance * item.customer.annual_rate / 100 / 365) %}
                                            {% set accrued_interest = daily_interest * item.days_overdue %}
                                            
                                            <small class="text-muted">
                                                Daily Interest: {{ daily_interest | safe_currency }}
                                            </small>
                                            <br><small class="text-warning">
                                                Accrued: {{ accrued_interest | safe_currency }}
                                            </small>
                                        </div>
                                    </td>
                                    <td>
                                        <div class="btn-group-vertical btn-group-sm">
                                            <a href="{{ url_for('customer_profile', customer_id=item.customer.id) }}" 
                                               class="btn btn-outline-primary action-button" title="View Details">
                                                <i class="fas fa-eye me-1"></i>View
                                            </a>
                                            
                                            <button class="btn btn-outline-info action-button" 
                                                    data-bs-toggle="modal" 
                                                    data-bs-target="#extendLoanModal{{ item.customer.id }}" 
                                                    title="Extend Loan">
                                                <i class="fas fa-calendar-plus me-1"></i>Extend
                                            </button>
                                            
                                            <button class="btn btn-outline-warning action-button" 
                                                    onclick="contactCustomer({{ item.customer.id }})" 
                                                    title="Contact Customer">
                                                <i class="fas fa-phone me-1"></i>Contact
                                            </button>
                                            
                                            <button class="btn btn-outline-secondary action-button" 
                                                    onclick="addNote({{ item.customer.id }})" 
                                                    title="Add Note">
                                                <i class="fas fa-sticky-note me-1"></i>Note
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Past Due Loans Section -->
    {% if past_due_customers %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card past-due-card">
                <div class="card-header bg-warning text-dark">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-clock me-2"></i>
                            Past Due Loans - Awaiting Action ({{ past_due_customers|length }})
                        </h5>
                        
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0" id="pastDueTable">
                            <thead class="table-light">
                                <tr>
                                    <th>Customer Details</th>
                                    <th>Loan Information</th>
                                    <th>Past Due Status</th>
                                    <th>Outstanding Amount</th>
                                    <th>Recommended Action</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in past_due_customers %}
                                <tr class="loan-row" data-customer-id="{{ item.customer.id }}" data-days="{{ item.days_past_due }}" data-amount="{{ item.balance }}">
                                    <td>
                                        <div class="loan-details">
                                            <strong>{{ item.customer.name }}</strong><br>
                                            <small class="text-muted">ICL: {{ item.customer.icl_no }}</small><br>
                                            {% if item.customer.contact_details %}
                                            <small class="text-info">
                                                <i class="fas fa-phone me-1"></i>{{ item.customer.contact_details }}
                                            </small>
                                            {% endif %}
                                        </div>
                                    </td>
                                    <td>
                                        <div class="loan-details">
                                            <strong>End Date:</strong> {{ item.customer.icl_end_date.strftime('%d-%m-%Y') }}<br>
                                            <strong>Rate:</strong> {{ item.customer.annual_rate }}%<br>
                                            <strong>Type:</strong> {{ item.customer.interest_type.title() }}
                                            {% if item.customer.tds_applicable %}
                                            <br><small class="text-warning">TDS: {{ item.customer.tds_percentage }}%</small>
                                            {% endif %}
                                        </div>
                                    </td>
                                    <td>
                                        <div class="text-center">
                                            <span class="badge 
                                                {% if item.days_past_due > 30 %}bg-danger
                                                {% elif item.days_past_due > 7 %}bg-warning text-dark
                                                {% else %}bg-info{% endif %}">
                                                {{ item.days_past_due }} days
                                            </span>
                                            <br><small class="text-muted">past due</small>
                                            
                                            {% if item.days_past_due > 30 %}
                                            <br><small class="text-danger">Urgent Action Required</small>
                                            {% elif item.days_past_due > 7 %}
                                            <br><small class="text-warning">Action Needed</small>
                                            {% endif %}
                                        </div>
                                    </td>
                                    <td>
                                        <div class="text-end">
                                            <div class="balance-amount">{{ item.balance | safe_currency }}</div>
                                            
                                            {% set daily_interest = (item.balance * item.customer.annual_rate / 100 / 365) %}
                                            {% set potential_loss = daily_interest * item.days_past_due %}
                                            
                                            <small class="text-muted">
                                                Daily: {{ daily_interest | safe_currency }}
                                            </small>
                                            <br><small class="text-warning">
                                                Risk: {{ potential_loss | safe_currency }}
                                            </small>
                                        </div>
                                    </td>
                                    <td>
                                        <div class="text-center">
                                            {% if item.days_past_due > 30 %}
                                            <span class="badge bg-danger">Mark Overdue</span>
                                            <br><small class="text-muted">Immediate action</small>
                                            {% elif item.days_past_due > 7 %}
                                            <span class="badge bg-warning text-dark">Extend or Mark</span>
                                            <br><small class="text-muted">Contact customer</small>
                                            {% else %}
                                            <span class="badge bg-info">Monitor</span>
                                            <br><small class="text-muted">Grace period</small>
                                            {% endif %}
                                        </div>
                                    </td>
                                    <td>
                                        <div class="btn-group-vertical btn-group-sm">
                                            <a href="{{ url_for('customer_profile', customer_id=item.customer.id) }}" 
                                               class="btn btn-outline-primary action-button">
                                                <i class="fas fa-eye me-1"></i>View
                                            </a>
                                            
                                            <button class="btn btn-outline-info action-button" 
                                                    data-bs-toggle="modal" 
                                                    data-bs-target="#extendLoanModal{{ item.customer.id }}">
                                                <i class="fas fa-calendar-plus me-1"></i>Extend
                                            </button>
                                            
                                            <form method="POST" action="{{ url_for('mark_overdue', customer_id=item.customer.id) }}" 
                                                  class="d-inline" onsubmit="return confirmMarkOverdue('{{ item.customer.name }}')">
                                                <button type="submit" class="btn btn-outline-danger action-button">
                                                    <i class="fas fa-exclamation-triangle me-1"></i>Mark Overdue
                                                </button>
                                            </form>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Extension Modals -->
    {% for item in (overdue_customers + past_due_customers) %}
    <div class="modal fade" id="extendLoanModal{{ item.customer.id }}" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <form method="POST" action="{{ url_for('extend_loan', customer_id=item.customer.id) }}">
                    <div class="modal-header bg-info text-white">
                        <h5 class="modal-title">
                            <i class="fas fa-calendar-plus me-2"></i>
                            Extend Loan for {{ item.customer.name }}
                        </h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <!-- Current Status -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <div class="card bg-light">
                                    <div class="card-body">
                                        <h6 class="card-title">Current Status</h6>
                                        <p class="mb-1"><strong>Current End Date:</strong> {{ item.customer.icl_end_date.strftime('%d-%m-%Y') }}</p>
                                        {% if item.customer.original_icl_end_date %}
                                        <p class="mb-1"><strong>Original End Date:</strong> {{ item.customer.original_icl_end_date.strftime('%d-%m-%Y') }}</p>
                                        {% endif %}
                                        <p class="mb-0"><strong>Outstanding:</strong> {{ item.balance | safe_currency }}</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card bg-light">
                                    <div class="card-body">
                                        <h6 class="card-title">Loan Details</h6>
                                        <p class="mb-1"><strong>Interest Rate:</strong> {{ item.customer.annual_rate }}%</p>
                                        <p class="mb-1"><strong>Type:</strong> {{ item.customer.interest_type.title() }}</p>
                                        <p class="mb-0"><strong>TDS:</strong> {{ item.customer.tds_percentage }}% {% if not item.customer.tds_applicable %}(Not Applicable){% endif %}</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Extension Details -->
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="new_end_date{{ item.customer.id }}" class="form-label">
                                        <i class="fas fa-calendar me-1"></i>New ICL End Date <span class="text-danger">*</span>
                                    </label>
                                    <input type="date" class="form-control" 
                                           id="new_end_date{{ item.customer.id }}" 
                                           name="new_end_date" 
                                           required 
                                           min="{{ (item.customer.icl_end_date + timedelta(days=1)).strftime('%Y-%m-%d') if item.customer.icl_end_date else '' }}"
                                           onchange="calculateExtension({{ item.customer.id }})">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Extension Period</label>
                                    <div class="form-control-plaintext bg-light p-2 rounded" id="extensionPeriod{{ item.customer.id }}">
                                        Select a new end date to see extension period
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="extension_reason{{ item.customer.id }}" class="form-label">
                                <i class="fas fa-comment me-1"></i>Extension Reason <span class="text-danger">*</span>
                            </label>
                            <select class="form-select mb-2" id="reasonSelect{{ item.customer.id }}" onchange="updateReasonText({{ item.customer.id }})">
                                <option value="">Select a reason...</option>
                                <option value="customer_request">Customer Request</option>
                                <option value="payment_delay">Payment Processing Delay</option>
                                <option value="financial_hardship">Customer Financial Hardship</option>
                                <option value="documentation_pending">Documentation Pending</option>
                                <option value="system_issue">System/Technical Issue</option>
                                <option value="legal_proceedings">Legal Proceedings</option>
                                <option value="other">Other (Please Specify)</option>
                            </select>
                            <textarea class="form-control" 
                                      id="extension_reason{{ item.customer.id }}" 
                                      name="extension_reason" 
                                      rows="3" 
                                      placeholder="Please provide detailed reason for extension..."
                                      required></textarea>
                        </div>

                        <!-- Impact Assessment -->
                        <div class="card bg-warning bg-opacity-10 border-warning">
                            <div class="card-body">
                                <h6 class="card-title text-warning">
                                    <i class="fas fa-exclamation-triangle me-2"></i>Impact Assessment
                                </h6>
                                <div id="impactAssessment{{ item.customer.id }}">
                                    <p class="mb-1"><strong>Additional Interest:</strong> <span id="additionalInterest{{ item.customer.id }}">-</span></p>
                                    <p class="mb-1"><strong>Total Extension Cost:</strong> <span id="extensionCost{{ item.customer.id }}">-</span></p>
                                    <p class="mb-0"><strong>New Total Amount:</strong> <span id="newTotalAmount{{ item.customer.id }}">-</span></p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            <i class="fas fa-times me-1"></i>Cancel
                        </button>
                        <button type="submit" class="btn btn-info">
                            <i class="fas fa-calendar-plus me-1"></i>Extend Loan
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    {% endfor %}

    <!-- Empty State -->
    {% if not overdue_customers and not past_due_customers %}
    <div class="row">
        <div class="col-12">
            <div class="text-center py-5">
                <div class="mb-4">
                    <i class="fas fa-check-circle fa-5x text-success"></i>
                </div>
                <h3 class="text-success mb-3">Excellent Loan Management!</h3>
                <p class="text-muted mb-4">
                    All loans are current and properly managed. No overdue or past-due loans require attention.
                </p>
                <div class="row justify-content-center">
                    <div class="col-md-8">
                        <div class="card bg-light">
                            <div class="card-body">
                                <h6 class="card-title">System Health Check</h6>
                                <div class="row text-center">
                                    <div class="col-md-4">
                                        <i class="fas fa-users fa-2x text-primary mb-2"></i>
                                        <p class="mb-0"><strong>Active Customers</strong></p>
                                        <p class="text-muted">All accounts current</p>
                                    </div>
                                    <div class="col-md-4">
                                        <i class="fas fa-calendar-check fa-2x text-success mb-2"></i>
                                        <p class="mb-0"><strong>On-Time Payments</strong></p>
                                        <p class="text-muted">100% compliance</p>
                                    </div>
                                    <div class="col-md-4">
                                        <i class="fas fa-chart-line fa-2x text-info mb-2"></i>
                                        <p class="mb-0"><strong>Performance</strong></p>
                                        <p class="text-muted">Optimal status</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="mt-4">
                    <a href="{{ url_for('dashboard') }}" class="btn btn-primary btn-lg me-3">
                        <i class="fas fa-arrow-left me-2"></i>Back to Dashboard
                    </a>
                    <a href="{{ url_for('reports') }}" class="btn btn-outline-info btn-lg">
                        <i class="fas fa-chart-bar me-2"></i>View Reports
                    </a>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Back Button -->
    <div class="row mt-4">
        <div class="col-12">
            <a href="{{ url_for('dashboard') }}" class="btn btn-secondary btn-lg">
                <i class="fas fa-arrow-left me-2"></i>Back to Dashboard
            </a>
        </div>
    </div>
</div>

<!-- Additional Modals -->
<!-- Note Modal -->
<div class="modal fade" id="noteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Note</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="noteForm">
                    <input type="hidden" id="noteCustomerId">
                    <div class="mb-3">
                        <label class="form-label">Note Type</label>
                        <select class="form-select" id="noteType" required>
                            <option value="">Select type...</option>
                            <option value="contact_attempt">Contact Attempt</option>
                            <option value="payment_promise">Payment Promise</option>
                            <option value="dispute">Dispute</option>
                            <option value="general">General Note</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Note</label>
                        <textarea class="form-control" id="noteText" rows="4" required></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveNote()">Save Note</button>
            </div>
        </div>
    </div>
</div>

<!-- Contact Modal -->
<div class="modal fade" id="contactModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Contact Customer</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="contactDetails"></div>
                <div class="mt-3">
                    <button class="btn btn-primary me-2" onclick="logContactAttempt()">
                        <i class="fas fa-phone me-1"></i>Call Now
                    </button>
                    <button class="btn btn-info me-2" onclick="sendEmail()">
                        <i class="fas fa-envelope me-1"></i>Send Email
                    </button>
                    <button class="btn btn-warning" onclick="sendSMS()">
                        <i class="fas fa-sms me-1"></i>Send SMS
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
$(document).ready(function() {
    // Initialize DataTables with enhanced features
    if ($('#overdueTable').length) {
        $('#overdueTable').DataTable({
            order: [[3, 'desc']], // Sort by days overdue
            pageLength: 25,
            responsive: true,
            dom: 'Bfrtip',
            buttons: ['copy', 'csv', 'excel', 'pdf', 'print'],
            columnDefs: [
                { orderable: false, targets: [5] }
            ]
        });
    }
    
    if ($('#pastDueTable').length) {
        $('#pastDueTable').DataTable({
            order: [[2, 'desc']], // Sort by days past due
            pageLength: 25,
            responsive: true,
            dom: 'Bfrtip',
            buttons: ['copy', 'csv', 'excel', 'pdf', 'print'],
            columnDefs: [
                { orderable: false, targets: [5] }
            ]
        });
    }
});

// Professional Functions
function filterLoans(filter) {
    $('.filter-tab').removeClass('active');
    event.target.classList.add('active');
    
    const rows = $('.loan-row');
    
    rows.show();
    
    if (filter === 'critical') {
        rows.hide();
        rows.filter('[data-days="90"], [data-days="91"], [data-days="92"], [data-days="93"], [data-days="94"], [data-days="95"], [data-days="96"], [data-days="97"], [data-days="98"], [data-days="99"], [data-days^="1"], [data-days^="2"], [data-days^="3"]').show();
    } else if (filter === 'high') {
        rows.hide();
        rows.filter(function() {
            const days = parseInt($(this).data('days'));
            return days >= 30 && days <= 89;
        }).show();
    } else if (filter === 'medium') {
        rows.hide();
        rows.filter(function() {
            const days = parseInt($(this).data('days'));
            return days >= 7 && days <= 29;
        }).show();
    } else if (filter === 'recent') {
        rows.hide();
        rows.filter(function() {
            const days = parseInt($(this).data('days'));
            return days >= 1 && days <= 6;
        }).show();
    }
}

function confirmMarkOverdue(customerName) {
    return confirm(`Are you sure you want to mark the loan for "${customerName}" as overdue?\n\nThis action will:\n- Change the loan status to overdue\n- Start accumulating penalty interest\n- Trigger collection procedures\n- Impact customer's credit standing\n\nThis action cannot be easily undone.`);
}

function calculateExtension(customerId) {
    const newEndDate = new Date($(`#new_end_date${customerId}`).val());
    const currentEndDate = new Date($(`#extendLoanModal${customerId}`).find('.card-body p:contains("Current End Date:")').text().split(': ')[1]);
    
    if (newEndDate && currentEndDate) {
        const diffTime = Math.abs(newEndDate - currentEndDate);
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        const diffMonths = Math.round(diffDays / 30);
        
        $(`#extensionPeriod${customerId}`).html(`
            <strong>${diffDays} days</strong> (≈ ${diffMonths} month${diffMonths !== 1 ? 's' : ''})
        `);
        
        // Calculate impact (simplified calculation)
        const balance = parseFloat($(`#extendLoanModal${customerId}`).find('.card-body p:contains("Outstanding:")').text().replace(/[^0-9.-]+/g, ""));
        const rate = parseFloat($(`#extendLoanModal${customerId}`).find('.card-body p:contains("Interest Rate:")').text().replace(/[^0-9.-]+/g, ""));
        
        const additionalInterest = (balance * rate / 100 / 365) * diffDays;
        const newTotal = balance + additionalInterest;
        
        $(`#additionalInterest${customerId}`).text(`₹${additionalInterest.toLocaleString('en-IN', {minimumFractionDigits: 2})}`);
        $(`#extensionCost${customerId}`).text(`₹${additionalInterest.toLocaleString('en-IN', {minimumFractionDigits: 2})}`);
        $(`#newTotalAmount${customerId}`).text(`₹${newTotal.toLocaleString('en-IN', {minimumFractionDigits: 2})}`);
    }
}

function updateReasonText(customerId) {
    const select = $(`#reasonSelect${customerId}`);
    const textarea = $(`#extension_reason${customerId}`);
    const selectedOption = select.find('option:selected');
    
    if (selectedOption.val()) {
        let reasonText = '';
        switch(selectedOption.val()) {
            case 'customer_request':
                reasonText = 'Extension requested by customer due to ';
                break;
            case 'payment_delay':
                reasonText = 'Payment processing delayed due to ';
                break;
            case 'financial_hardship':
                reasonText = 'Customer experiencing financial hardship: ';
                break;
            case 'documentation_pending':
                reasonText = 'Required documentation pending: ';
                break;
            case 'system_issue':
                reasonText = 'System/technical issue affecting payment: ';
                break;
            case 'legal_proceedings':
                reasonText = 'Legal proceedings affecting loan status: ';
                break;
            case 'other':
                reasonText = 'Other reason: ';
                break;
        }
        textarea.val(reasonText);
        textarea.focus();
    }
}

function addNote(customerId) {
    $('#noteCustomerId').val(customerId);
    $('#noteModal').modal('show');
}

function saveNote() {
    const customerId = $('#noteCustomerId').val();
    const noteType = $('#noteType').val();
    const noteText = $('#noteText').val();
    
    if (!noteType || !noteText) {
        alert('Please fill in all required fields.');
        return;
    }
    
    // Here you would typically send the note to the server
    console.log('Saving note for customer:', customerId, 'Type:', noteType, 'Note:', noteText);
    
    // Show success message
    $('#noteModal').modal('hide');
    showAlert('Note saved successfully!', 'success');
    
    // Reset form
    $('#noteForm')[0].reset();
}

function contactCustomer(customerId) {
    // Load customer contact details
    // In a real implementation, you'd fetch this from the server
    $('#contactDetails').html(`
        <h6>Customer Contact Information</h6>
        <p><strong>Phone:</strong> Loading...</p>
        <p><strong>Email:</strong> Loading...</p>
        <p><strong>Address:</strong> Loading...</p>
    `);
    
    $('#contactModal').modal('show');
}

function logContactAttempt() {
    // Log the contact attempt
    console.log('Contact attempt logged');
    showAlert('Contact attempt logged successfully!', 'info');
    $('#contactModal').modal('hide');
}

function sendEmail() {
    // Send email functionality
    console.log('Sending email...');
    showAlert('Email sent successfully!', 'success');
}

function sendSMS() {
    // Send SMS functionality
    console.log('Sending SMS...');
    showAlert('SMS sent successfully!', 'success');
}

function exportOverdueReport() {
    // Export functionality
    showAlert('Overdue report export started. You will receive an email when ready.', 'info');
}

function refreshData() {
    location.reload();
}

function showAlert(message, type) {
    const alertClass = `alert-${type}`;
    const alertHtml = `
        <div class="alert ${alertClass} alert-dismissible fade show" role="alert">
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;
    
    // Add to top of container
    $('.container-fluid').prepend(alertHtml);
    
    // Auto-dismiss after 5 seconds
    setTimeout(() => {
        $('.alert').fadeOut();
    }, 5000);
}

function sortOverdue(criteria) {
    const table = $('#overdueTable').DataTable();
    if (criteria === 'days') {
        table.order([4, 'desc']).draw();
    } else if (criteria === 'amount') {
        table.order([5, 'desc']).draw();
    }
}
</script>
{% endblock %}
