{% extends "base.html" %}

{% block title %}Issue Stock - Request {{ request.request_no }} -  Stock Management{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Header -->
    <div class="md:flex md:items-center md:justify-between">
        <div class="flex-1 min-w-0">
            <h2 class="text-2xl font-bold leading-7 text-white sm:text-3xl sm:truncate">
                Issue Stock - Request {{ request.request_no }}
            </h2>
            <p class="mt-1 text-sm text-gray-400">
                Process approved stock request
            </p>
        </div>
    </div>

    <!-- Request Summary -->
    <div class="bg-gray-800 shadow overflow-hidden sm:rounded-lg">
        <div class="px-4 py-5 sm:px-6">
            <h3 class="text-lg leading-6 font-medium text-white">Request Summary</h3>
            <div class="mt-2 grid grid-cols-1 gap-4 sm:grid-cols-3">
                <div>
                    <span class="text-sm text-gray-400">Requester:</span>
                    <span class="ml-2 text-sm text-white">{{ request.requester.full_name }}</span>
                </div>
                <div>
                    <span class="text-sm text-gray-400">Department:</span>
                    <span class="ml-2 text-sm text-white">{{ request.department.name }}</span>
                </div>
                <div>
                    <span class="text-sm text-gray-400">Location:</span>
                    <span class="ml-2 text-sm text-white">{{ request.location.code }}</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Issue Form -->
    <div class="bg-gray-800 shadow overflow-hidden sm:rounded-lg">
        <div class="px-4 py-5 sm:px-6">
            <h3 class="text-lg leading-6 font-medium text-white">Issue Items</h3>
            <p class="mt-1 text-sm text-gray-400">
                Specify the actual quantities to be issued
            </p>
        </div>
        <div class="border-t border-gray-700">
            <form method="POST" action="{{ url_for('stock_issue.process_issue', request_id=request.id) }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>

                <div class="space-y-6">
                    {% for line in request.issue_lines %}
                    <div class="bg-gray-700 rounded-lg p-6 border border-gray-600">
                        <!-- Item Header -->
                        <div class="flex items-start justify-between mb-4">
                            <div class="flex-1">
                                <h4 class="text-xl font-semibold text-white mb-2">{{ line.item.name }}</h4>
                                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 text-sm">
                                    <div>
                                        <span class="text-gray-400">Item Code:</span>
                                        <span class="ml-2 text-white font-medium">{{ line.item.code }}</span>
                                    </div>
                                    <div>
                                        <span class="text-gray-400">Department:</span>
                                        <span class="ml-2 text-white font-medium">
                                            {% if line.item.department %}
                                                {{ line.item.department.name }}
                                            {% else %}
                                                General
                                            {% endif %}
                                        </span>
                                    </div>
                                    <div>
                                        <span class="text-gray-400">Requested Qty:</span>
                                        <span class="ml-2 text-blue-400 font-semibold text-lg">{{ line.quantity_requested }}</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Item Description -->
                        {% if line.item.description %}
                        <div class="mb-4">
                            <span class="text-sm text-gray-400">Description:</span>
                            <p class="mt-1 text-sm text-white bg-gray-800 rounded-md p-3">{{ line.item.description }}</p>
                        </div>
                        {% endif %}

                        <!-- Item Remarks -->
                        {% if line.remarks %}
                        <div class="mb-4">
                            <span class="text-sm text-gray-400">Remarks:</span>
                            <p class="mt-1 text-sm text-white bg-gray-800 rounded-md p-3">{{ line.remarks }}</p>
                        </div>
                        {% endif %}

                        <!-- Stock Information and Issue Quantity -->
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                            <div>
                                <span class="text-sm text-gray-400">Available Stock:</span>
                                <div class="mt-1">
                                    <span class="text-lg font-semibold {% if stock_balances[line.item_id] < line.quantity_requested %}text-red-400{% else %}text-green-400{% endif %}">
                                        {{ stock_balances[line.item_id] }}
                                    </span>
                                    {% if stock_balances[line.item_id] < line.quantity_requested %}
                                    <span class="ml-2 text-xs text-red-400">(Insufficient)</span>
                                    {% endif %}
                                </div>
                            </div>
                            <div>
                                <span class="text-sm text-gray-400">Max Issuable:</span>
                                <div class="mt-1">
                                    <span class="text-lg font-semibold text-yellow-400">
                                        {{ [line.quantity_requested, stock_balances[line.item_id]]|min }}
                                    </span>
                                </div>
                            </div>
                            <div>
                                
                                
                                    <label for="quantity_{{ line.id }}" class="block text-sm font-medium text-gray-300 mb-1">Quantity to Issue</label>
                                    
                                    <input type="hidden" name="line_id[]" value="{{ line.id }}">
                                    <input type="number" 
                                           name="quantity_issued[]" 
                                           id="quantity_{{ line.id }}"
                                           value="{{ [line.quantity_requested, stock_balances[line.item_id]]|min }}"
                                           min="0" 
                                           max="{{ [line.quantity_requested, stock_balances[line.item_id]]|min }}"
                                           step="0.01"
                                           class="block w-full border-gray-600 rounded-md shadow-sm bg-gray-800 text-white focus:ring-purple-500 focus:border-purple-500 text-lg font-semibold">
                                
                            </div>
                        </div>

                        <!-- Additional Item Details -->
                        {% if line.item.make or line.item.variant %}
                        <div class="mt-4 pt-4 border-t border-gray-600">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                                {% if line.item.make %}
                                <div>
                                    <span class="text-gray-400">Make:</span>
                                    <span class="ml-2 text-white">{{ line.item.make }}</span>
                                </div>
                                {% endif %}
                                {% if line.item.variant %}
                                <div>
                                    <span class="text-gray-400">Variant:</span>
                                    <span class="ml-2 text-white">{{ line.item.variant }}</span>
                                </div>
                                
                                {% endif %}
                                <div>
                                    <button type="submit" class="custom-btn w-100 mb-2" data-bs-toggle="modal">
                                        <i class="fas fa-shipping-fast me-2"></i>
                                      Issue Stock
                                    </button>

                                    <style>
                                    .custom-btn {
                                      background-color: #6f42c1; /* Bootstrap purple shade */
                                      color: white;
                                      border: none;
                                      border-radius: 12px; /* round corners */
                                      padding: 10px 16px;
                                      font-size: 16px;
                                      font-weight: 500;
                                      transition: all 0.3s ease;
                                    }

                                    .custom-btn:hover {
                                      background-color: #5a32a3; /* darker purple on hover */
                                      color: #fff;
                                      transform: translateY(-2px);
                                      box-shadow: 0 4px 8px rgba(0,0,0,0.15);
                                    }

                                    .custom-btn:active {
                                      transform: translateY(0);
                                      box-shadow: none;
                                    }
                                    </style>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
            </form>
        </div>
    </div>

    <!-- Stock Warnings -->
    {% set has_insufficient = false %}
    {% for line in request.issue_lines %}
        {% if stock_balances[line.item_id] < line.quantity_requested %}
            {% set has_insufficient = true %}
        {% endif %}
    {% endfor %}

    {% if has_insufficient %}
    <div class="bg-red-900 border border-red-800 rounded-md p-4">
        <div class="flex">
            <div class="flex-shrink-0">
                <i class="fas fa-exclamation-triangle text-red-400"></i>
            </div>
            <div class="ml-3">
                <h3 class="text-sm font-medium text-red-200">Insufficient Stock Warning</h3>
                <div class="mt-2 text-sm text-red-200">
                    Some items have insufficient stock. The system has automatically adjusted the issue quantities to match available stock.
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Instructions -->
    <div class="bg-blue-900 border border-blue-800 rounded-md p-4">
        <div class="flex">
            <div class="flex-shrink-0">
                <i class="fas fa-info-circle text-blue-400"></i>
            </div>
            <div class="ml-3">
                <h3 class="text-sm font-medium text-blue-200">Instructions</h3>
                <div class="mt-2 text-sm text-blue-200">
                    <ul class="list-disc list-inside space-y-1">
                        <li>Verify the quantities before issuing stock.</li>
                        <li>You can issue partial quantities if full stock is not available.</li>
                        <li>Stock will be automatically deducted from the selected location.</li>
                        <li>This action cannot be undone once completed.</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}