
{% extends "base.html" %}

{% block title %}Stock History - {{ item.code }} at {{ location.name }}{% endblock %}

{% block content %}
<div class="space-y-8">
    <!-- Header Section -->
    <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between">
        <div>
            <div class="flex items-center mb-2">
                <a href="{{ url_for('stock_entry.balances') }}" class="text-blue-400 hover:text-blue-300 mr-3">
                    <i class="fas fa-arrow-left"></i>
                </a>
                <h1 class="text-3xl font-bold text-white flex items-center">
                    <i class="fas fa-history text-blue-400 mr-4"></i>
                    Stock History
                </h1>
            </div>
            <p class="text-gray-400">Movement history for {{ item.code }} - {{ item.name }} at {{ location.office }} {{ location.room }}</p>
        </div>
        <div class="mt-4 lg:mt-0">
            <button onclick="exportHistory()" class="glass-effect hover:bg-gray-700/50 text-white px-6 py-3 rounded-xl font-medium transition-all duration-300">
                <i class="fas fa-download mr-2"></i>Export History
            </button>
        </div>
    </div>

    <!-- Current Balance Card -->
    <div class="glass-effect rounded-2xl p-6">
        <div class="flex items-center justify-between">
            <div>
                <h3 class="text-lg font-semibold text-white mb-2">Current Stock Balance</h3>
                <div class="flex items-center">
                    <div class="w-12 h-12 bg-gradient-to-r from-blue-500 to-purple-600 rounded-lg flex items-center justify-center mr-4">
                        <i class="fas fa-box text-white"></i>
                    </div>
                    <div>
                        <div class="font-medium text-white">{{ item.code }} - {{ item.name }}</div>
                        <div class="text-sm text-gray-400">{{ location.office }} - {{ location.room }}</div>
                    </div>
                </div>
            </div>
            <div class="text-right">
                <div class="text-3xl font-bold
                    {% if current_balance and current_balance.quantity > item.low_stock_threshold %}text-green-400
                    {% elif current_balance and current_balance.quantity > 5 %}text-yellow-400
                    {% elif current_balance and current_balance.quantity > 0 %}text-red-400
                    {% else %}text-gray-500
                    {% endif %}">
                    {{ current_balance.quantity if current_balance else 0 }}
                </div>
                <div class="text-sm text-gray-400">Current Stock</div>
            </div>
        </div>
    </div>

    <!-- History Timeline -->
    <div class="glass-effect rounded-2xl overflow-hidden">
        <div class="p-6 border-b border-gray-700">
            <h2 class="text-xl font-semibold text-white flex items-center">
                <i class="fas fa-timeline text-blue-400 mr-3"></i>
                Stock Movement Timeline
            </h2>
        </div>
        
        <div class="p-6">
            {% set all_movements = [] %}
            
            <!-- Combine entries and issues into one timeline -->
            {% for entry in stock_entries %}
                {% set _ = all_movements.append({
                    'type': 'entry',
                    'date': entry.created_at,
                    'quantity': entry.quantity_procured,
                    'description': entry.description,
                    'remarks': entry.remarks,
                    'user': entry.creator.full_name,
                    'reference': 'Stock Entry #' + entry.id|string
                }) %}
            {% endfor %}
            
            {% for issue_line, request in stock_issues %}
                {% if issue_line.quantity_issued %}
                    {% set _ = all_movements.append({
                        'type': 'issue',
                        'date': request.issued_at,
                        'quantity': issue_line.quantity_issued,
                        'description': request.purpose,
                        'remarks': issue_line.remarks,
                        'user': request.issuer.full_name if request.issuer else 'System',
                        'reference': 'Issue Request ' + request.request_no
                    }) %}
                {% endif %}
            {% endfor %}
            
            <!-- Sort all movements by date descending -->
            {% set sorted_movements = all_movements|sort(attribute='date', reverse=true) %}
            
            {% if sorted_movements %}
            <div class="space-y-4">
                {% for movement in sorted_movements %}
                <div class="flex items-start space-x-4 p-4 rounded-xl bg-gray-800/30 hover:bg-gray-800/50 transition-colors duration-200">
                    <!-- Movement Type Icon -->
                    <div class="flex-shrink-0 w-12 h-12 rounded-lg flex items-center justify-center
                        {% if movement.type == 'entry' %}bg-green-500/20 border border-green-500/30
                        {% else %}bg-red-500/20 border border-red-500/30
                        {% endif %}">
                        {% if movement.type == 'entry' %}
                        <i class="fas fa-plus text-green-400"></i>
                        {% else %}
                        <i class="fas fa-minus text-red-400"></i>
                        {% endif %}
                    </div>
                    
                    <!-- Movement Details -->
                    <div class="flex-grow">
                        <div class="flex items-center justify-between mb-2">
                            <div class="flex items-center space-x-3">
                                <span class="font-medium text-white">{{ movement.reference }}</span>
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium
                                    {% if movement.type == 'entry' %}bg-green-500/20 text-green-300 border border-green-500/30
                                    {% else %}bg-red-500/20 text-red-300 border border-red-500/30
                                    {% endif %}">
                                    {% if movement.type == 'entry' %}Stock In{% else %}Stock Out{% endif %}
                                </span>
                            </div>
                            <div class="text-right">
                                <div class="font-bold text-2xl
                                    {% if movement.type == 'entry' %}text-green-400
                                    {% else %}text-red-400
                                    {% endif %}">
                                    {% if movement.type == 'entry' %}+{% else %}-{% endif %}{{ movement.quantity }}
                                </div>
                            </div>
                        </div>
                        
                        <div class="text-sm text-gray-400 mb-2">
                            <i class="fas fa-clock mr-1"></i>
                            {{ movement.date.strftime('%B %d, %Y at %I:%M %p') }}
                            <span class="mx-2">â€¢</span>
                            <i class="fas fa-user mr-1"></i>
                            {{ movement.user }}
                        </div>
                        
                        {% if movement.description %}
                        <div class="text-sm text-gray-300 mb-1">
                            <i class="fas fa-info-circle mr-1"></i>
                            <strong>Description:</strong> {{ movement.description }}
                        </div>
                        {% endif %}
                        
                        {% if movement.remarks %}
                        <div class="text-sm text-gray-300">
                            <i class="fas fa-comment mr-1"></i>
                            <strong>Remarks:</strong> {{ movement.remarks }}
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="text-center py-12">
                <i class="fas fa-history text-gray-600 text-6xl mb-4"></i>
                <h3 class="text-xl font-medium text-gray-400 mb-2">No Movement History</h3>
                <p class="text-gray-500">No stock movements have been recorded for this item at this location.</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
function exportHistory() {
    // Get the item and location data
    const itemCode = '{{ item.code }}';
    const itemName = '{{ item.name }}';
    const locationName = '{{ location.office }} {{ location.room }}';
    
    // Create CSV content
    let csvContent = 'Date,Type,Reference,Quantity,User,Description,Remarks\n';
    
    {% for movement in sorted_movements %}
    csvContent += '"{{ movement.date.strftime('%Y-%m-%d %H:%M:%S') }}",';
    csvContent += '"{{ movement.type|title }}",';
    csvContent += '"{{ movement.reference }}",';
    csvContent += '{{ movement.quantity }},';
    csvContent += '"{{ movement.user }}",';
    csvContent += '"{{ movement.description or '' }}",';
    csvContent += '"{{ movement.remarks or '' }}"\n';
    {% endfor %}
    
    // Create and download the file
    const blob = new Blob([csvContent], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `stock_history_${itemCode}_${new Date().toISOString().split('T')[0]}.csv`;
    a.click();
    window.URL.revokeObjectURL(url);
    
    showNotification('Stock history exported successfully!', 'success');
}

// Show notification function
function showNotification(message, type) {
    // Create notification element
    const notification = document.createElement('div');
    notification.className = `fixed top-4 right-4 z-50 px-6 py-3 rounded-lg font-medium transition-all duration-300 ${
        type === 'success' ? 'bg-green-500 text-white' : 'bg-red-500 text-white'
    }`;
    notification.textContent = message;
    
    document.body.appendChild(notification);
    
    // Remove after 3 seconds
    setTimeout(() => {
        notification.style.opacity = '0';
        setTimeout(() => {
            document.body.removeChild(notification);
        }, 300);
    }, 3000);
}
</script>
{% endblock %}
