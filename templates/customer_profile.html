{% extends "base.html" %}

{% block title %}{{ customer.name }} - Customer Profile{% endblock %}

{% block content %}
<div class="container">
    <!-- Customer Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1><i class="fas fa-user me-2"></i>{{ customer.name }}</h1>
                    <p class="text-muted">ICL No: {{ customer.icl_no }}</p>
                </div>
                <div>
                    {% if current_user.role in ['admin', 'data_entry'] %}
                    <a href="{{ url_for('transactions', customer_id=customer.id) }}" class="btn btn-success">
                        <i class="fas fa-plus me-2"></i>Add Transaction
                    </a>
                    <a href="{{ url_for('edit_customer', customer_id=customer.id) }}" class="btn btn-warning">
                        <i class="fas fa-edit me-2"></i>Edit Customer
                    </a>
                    {% endif %}
                    <a href="{{ url_for('export_customer_report', customer_id=customer.id) }}" class="btn btn-info">
                        <i class="fas fa-download me-2"></i>Export Report
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Customer Details -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-info-circle me-2"></i>Customer Information</h5>
                </div>
                <div class="card-body">
                    <dl class="row">
                        <dt class="col-sm-4">ICL No:</dt>
                        <dd class="col-sm-8">{{ customer.icl_no }}</dd>

                        <dt class="col-sm-4">Name:</dt>
                        <dd class="col-sm-8">{{ customer.name }}</dd>

                        <dt class="col-sm-4">Address:</dt>
                        <dd class="col-sm-8">{{ customer.address or 'Not provided' }}</dd>

                        <dt class="col-sm-4">Contact:</dt>
                        <dd class="col-sm-8">{{ customer.contact_details or 'Not provided' }}</dd>

                        <dt class="col-sm-4">Annual Rate:</dt>
                        <dd class="col-sm-8">{{ customer.annual_rate | safe_percentage }}</dd>

                        <dt class="col-sm-4">Interest Type:</dt>
                        <dd class="col-sm-8">
                            <span class="badge bg-info">{{ customer.interest_type.title() }}</span>
                            {% if customer.interest_type == 'compound' and customer.compound_frequency %}
                                <small class="text-muted">({{ customer.compound_frequency.title() }})</small>
                            {% endif %}
                        </dd>

                        <dt class="col-sm-4">TDS Applicable:</dt>
                        <dd class="col-sm-8">
                            {% if customer.tds_applicable %}
                                <span class="badge bg-success">Yes</span>
				<dt class="col-sm-4">TDS %: </dt>
				<dd class="col-sm-8">{{ customer.tds_percentage | safe_percentage }} </dd>
                            {% else %}
                                <span class="badge bg-secondary">No</span>
                            {% endif %}
                        </dd>
                    </dl>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-calendar me-2"></i>Account Timeline</h5>
                </div>
                <div class="card-body">
                    <dl class="row">
                        <dt class="col-sm-4">Start Date:</dt>
                        <dd class="col-sm-8">{{ customer.icl_start_date.strftime('%d-%m-%Y') if customer.icl_start_date else 'Not set' }}</dd>

                        <dt class="col-sm-4">End Date:</dt>
                        <dd class="col-sm-8">{{ customer.icl_end_date.strftime('%d-%m-%Y') if customer.icl_end_date else 'Not set' }}</dd>

                        <dt class="col-sm-4">Extension:</dt>
                        <dd class="col-sm-8">{{ customer.icl_extension or 'None' }}</dd>

                        {% if customer.first_compounding_date %}
                        <dt class="col-sm-4">First Compounding:</dt>
                        <dd class="col-sm-8">{{ customer.first_compounding_date.strftime('%d-%m-%Y') }}</dd>
                        {% endif %}

                        <dt class="col-sm-4">Created:</dt>
                        <dd class="col-sm-8">{{ customer.created_at.strftime('%d-%m-%Y') if customer.created_at else 'Unknown' }}</dd>
                    </dl>
                </div>
            </div>
        </div>
    </div>

    <!-- Current Balance Card -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="card-title">Current Outstanding Balance</h5>
                            <h2 class="mb-0">{{ current_balance | safe_currency }}</h2>
                        </div>
                        <div>
                            <i class="fas fa-balance-scale fa-3x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Transaction History (Aggregated View) -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5><i class="fas fa-chart-line me-2"></i>Financial Summary</h5>
                    <div class="btn-group" role="group" aria-label="Period View">
                        <button type="button" class="btn btn-outline-primary active" data-period="quarterly">Quarterly</button>
                        <button type="button" class="btn btn-outline-primary" data-period="half_yearly">Half-Yearly</button>
                        <button type="button" class="btn btn-outline-primary" data-period="yearly">Yearly</button>
                    </div>
                </div>
                <div class="card-body">
                    <div id="quarterly_summary" class="period-summary-table">
                        {% if quarterly_summary %}
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th>Period</th>
                                        <th>Start Date</th>
                                        <th>End Date</th>
                                        <th class="text-end">Opening Balance</th>
                                        <th class="text-end">Total Paid</th>
                                        <th class="text-end">Total Repaid</th>
                                        <th class="text-end">Total Interest</th>
                                        <th class="text-end">Total TDS</th>
                                        <th class="text-end">Total Net Amount</th>
                                        <th class="text-end">Closing Balance</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for period in quarterly_summary %}
                                    <tr>
                                        <td>{{ period.period_name }}</td>
                                        <td>{{ period.start_date.strftime('%d-%m-%Y') }}</td>
                                        <td>{{ period.end_date.strftime('%d-%m-%Y') }}</td>
                                        <td class="text-end">{{ period.opening_balance | safe_currency }}</td>
                                        <td class="text-end text-success">{{ period.total_paid | safe_currency }}</td>
                                        <td class="text-end text-danger">{{ period.total_repaid | safe_currency }}</td>
                                        <td class="text-end">{{ period.total_interest | safe_currency }}</td>
                                        <td class="text-end">{{ period.total_tds | safe_currency }}</td>
                                        <td class="text-end text-primary">{{ period.total_net_amount | safe_currency }}</td>
                                        <td class="text-end"><strong>{{ period.closing_balance | safe_currency }}</strong></td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% else %}
                        <div class="text-center py-4">
                            <i class="fas fa-chart-pie fa-3x text-muted mb-3"></i>
                            <h5 class="text-muted">No quarterly data available.</h5>
                            <p class="text-muted">Add transactions to see financial summaries.</p>
                        </div>
                        {% endif %}
                    </div>

                    <div id="half_yearly_summary" class="period-summary-table" style="display: none;">
                        {% if half_yearly_summary %}
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th>Period</th>
                                        <th>Start Date</th>
                                        <th>End Date</th>
                                        <th class="text-end">Opening Balance</th>
                                        <th class="text-end">Total Paid</th>
                                        <th class="text-end">Total Repaid</th>
                                        <th class="text-end">Total Interest</th>
                                        <th class="text-end">Total TDS</th>
                                        <th class="text-end">Total Net Amount</th>
                                        <th class="text-end">Closing Balance</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for period in half_yearly_summary %}
                                    <tr>
                                        <td>{{ period.period_name }}</td>
                                        <td>{{ period.start_date.strftime('%d-%m-%Y') }}</td>
                                        <td>{{ period.end_date.strftime('%d-%m-%Y') }}</td>
                                        <td class="text-end">{{ period.opening_balance | safe_currency }}</td>
                                        <td class="text-end text-success">{{ period.total_paid | safe_currency }}</td>
                                        <td class="text-end text-danger">{{ period.total_repaid | safe_currency }}</td>
                                        <td class="text-end">{{ period.total_interest | safe_currency }}</td>
                                        <td class="text-end">{{ period.total_tds | safe_currency }}</td>
                                        <td class="text-end text-primary">{{ period.total_net_amount | safe_currency }}</td>
                                        <td class="text-end"><strong>{{ period.closing_balance | safe_currency }}</strong></td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% else %}
                        <div class="text-center py-4">
                            <i class="fas fa-chart-pie fa-3x text-muted mb-3"></i>
                            <h5 class="text-muted">No half-yearly data available.</h5>
                            <p class="text-muted">Add transactions to see financial summaries.</p>
                        </div>
                        {% endif %}
                    </div>

                    <div id="yearly_summary" class="period-summary-table" style="display: none;">
                        {% if yearly_summary %}
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th>Period</th>
                                        <th>Start Date</th>
                                        <th>End Date</th>
                                        <th class="text-end">Opening Balance</th>
                                        <th class="text-end">Total Paid</th>
                                        <th class="text-end">Total Repaid</th>
                                        <th class="text-end">Total Interest</th>
                                        <th class="text-end">Total TDS</th>
                                        <th class="text-end">Total Net Amount</th>
                                        <th class="text-end">Closing Balance</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for period in yearly_summary %}
                                    <tr>
                                        <td>{{ period.period_name }}</td>
                                        <td>{{ period.start_date.strftime('%d-%m-%Y') }}</td>
                                        <td>{{ period.end_date.strftime('%d-%m-%Y') }}</td>
                                        <td class="text-end">{{ period.opening_balance | safe_currency }}</td>
                                        <td class="text-end text-success">{{ period.total_paid | safe_currency }}</td>
                                        <td class="text-end text-danger">{{ period.total_repaid | safe_currency }}</td>
                                        <td class="text-end">{{ period.total_interest | safe_currency }}</td>
                                        <td class="text-end">{{ period.total_tds | safe_currency }}</td>
                                        <td class="text-end text-primary">{{ period.total_net_amount | safe_currency }}</td>
                                        <td class="text-end"><strong>{{ period.closing_balance | safe_currency }}</strong></td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% else %}
                        <div class="text-center py-4">
                            <i class="fas fa-chart-pie fa-3x text-muted mb-3"></i>
                            <h5 class="text-muted">No yearly data available.</h5>
                            <p class="text-muted">Add transactions to see financial summaries.</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Back Button -->
    <div class="row mt-4">
        <div class="col-12">
            <a href="{{ url_for('dashboard') }}" class="btn btn-secondary">
                <i class="fas fa-arrow-left me-2"></i>Back to Dashboard
            </a>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
$(document).ready(function() {
    // Handle period view selection
    $('.btn-group button').on('click', function() {
        // Remove active class from all buttons
        $('.btn-group button').removeClass('active');
        // Add active class to the clicked button
        $(this).addClass('active');

        // Hide all summary tables
        $('.period-summary-table').hide();

        // Show the selected summary table
        const periodType = $(this).data('period');
        $('#' + periodType + '_summary').show();
    });

    // Initialize DataTables for each summary table (if they exist)
    // Note: DataTables might not be ideal for aggregated tables that are small or dynamically shown/hidden.
    // If performance issues arise, consider removing DataTable initialization for these summary tables.
    // For now, I'll keep the basic DataTable initialization logic.
    $('.period-summary-table table').each(function() {
        if (!$.fn.DataTable.isDataTable(this)) {
            $(this).DataTable({
                "paging": false, // No pagination for summary tables
                "searching": false, // No search for summary tables
                "info": false, // No info text
                "ordering": false, // No sorting
                "responsive": true,
                "columnDefs": [
                    {
                        "targets": [3, 4, 5, 6, 7, 8, 9], // Balance and amount columns
                        "className": "text-end"
                    }
                ]
            });
        }
    });

    // Ensure the initially active tab's DataTable is rendered if it has data
    // This might be redundant if DataTables are initialized on all tables, but good for clarity.
    $('#quarterly_summary table').DataTable(); // Initialize the default visible table
});
</script>
{% endblock %}