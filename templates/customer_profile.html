{% extends "base.html" %}

{% block title %}{{ customer.name }} - Customer Profile{% endblock %}
{% block content %}
<div class="container">
    <!-- Customer Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1><i class="fas fa-user me-2"></i>{{ customer.name }} </h1>
                    <p class="text-muted">ICL No: {{ customer.icl_no }}</p>
                </div>
                <div>
                    {% if current_user.role in ['admin', 'data_entry'] %}
                    <a href="{{ url_for('transactions', customer_id=customer.id) }}" class="btn btn-success">
                        <i class="fas fa-plus me-2"></i>Add Transaction
                    </a>
                    <a href="{{ url_for('edit_customer', customer_id=customer.id) }}" class="btn btn-warning">
                        <i class="fas fa-edit me-2"></i>Edit Customer
                    </a>
                    {% endif %}
                    <a href="{{ url_for('export_customer_report', customer_id=customer.id) }}" class="btn btn-info">
                        <i class="fas fa-download me-2"></i>Export Report
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Customer Details -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-info-circle me-2"></i>Customer Information</h5>
                </div>
                <div class="card-body">
                    <dl class="row">
                        <dt class="col-sm-4">ICL No:</dt>
                        <dd class="col-sm-8">{{ customer.icl_no }}</dd>

                        <dt class="col-sm-4">Name:</dt>
                        <dd class="col-sm-8">{{ customer.name }}</dd>

                        <dt class="col-sm-4">Address:</dt>
                        <dd class="col-sm-8">{{ customer.address or 'Not provided' }}</dd>

                        <dt class="col-sm-4">Contact:</dt>
                        <dd class="col-sm-8">{{ customer.contact_details or 'Not provided' }}</dd>

                        <dt class="col-sm-4">Annual Rate:</dt>
                        <dd class="col-sm-8">{{ customer.annual_rate | safe_percentage }}</dd>

                        <dt class="col-sm-4">Interest Type:</dt>
                        <dd class="col-sm-8">
                            <span class="badge bg-info">{{ customer.interest_type.title() }}</span>
                            {% if customer.interest_type == 'compound' and customer.compound_frequency %}
                                <small class="text-muted">({{ customer.compound_frequency.title() }})</small>
                            {% endif %}
                        </dd>

                        <dt class="col-sm-4">TDS Applicable:</dt>
                        <dd class="col-sm-8">
                            {% if customer.tds_applicable %}
                                <span class="badge bg-success">Yes</span>
				<dt class="col-sm-4">TDS %: </dt>
				<dd class="col-sm-8">{{ customer.tds_percentage | safe_percentage }} </dd>
                            {% else %}
                                <span class="badge bg-secondary">No</span>
                            {% endif %}
                        </dd>
                    </dl>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-calendar me-2"></i>Account Timeline</h5>
                </div>
                <div class="card-body">
                    <dl class="row">
                        <dt class="col-sm-4">Start Date:</dt>
                        <dd class="col-sm-8">{{ customer.icl_start_date.strftime('%d-%m-%Y') if customer.icl_start_date else 'Not set' }}</dd>

                        <dt class="col-sm-4">End Date:</dt>
                        <dd class="col-sm-8">{{ customer.icl_end_date.strftime('%d-%m-%Y') if customer.icl_end_date else 'Not set' }}</dd>

                        <dt class="col-sm-4">Effective End Date:</dt>
                        <dd class="col-sm-8">
                            {% if customer.get_effective_end_date() %}
                                <span class="badge bg-warning text-dark">{{ customer.get_effective_end_date().strftime('%d-%m-%Y') }}</span>
                                {% if customer.get_last_transaction_date() and customer.get_last_transaction_date() == customer.get_effective_end_date() %}
                                    <small class="text-muted">(Based on last transaction)</small>
                                {% endif %}
                            {% else %}
                                <span class="text-muted">Not determined</span>
                            {% endif %}
                        </dd>

                        <dt class="col-sm-4">Extension:</dt>
                        <dd class="col-sm-8">{{ customer.icl_extension or 'None' }}</dd>

                        {% if customer.first_compounding_date %}
                        <dt class="col-sm-4">First Compounding:</dt>
                        <dd class="col-sm-8">{{ customer.first_compounding_date.strftime('%d-%m-%Y') }}</dd>
                        {% endif %}

                        <dt class="col-sm-4">Created:</dt>
                        <dd class="col-sm-8">{{ customer.created_at.strftime('%d-%m-%Y') if customer.created_at else 'Unknown' }}</dd>
                    </dl>
                </div>
            </div>
        </div>
    </div>

    <!-- Current Balance Card -->
    <div class="row mb-4">
        <div class="col-md-8">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="card-title">Current Outstanding Balance</h5>
                            <h2 class="mb-0">{{ current_balance | safe_currency }}</h2>
                        </div>
                        <div>
                            <i class="fas fa-balance-scale fa-3x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Real-time Balance Calculator -->
        <div class="col-md-4">
            <div class="card bg-info text-white">
                <div class="card-header">
                    <h6 class="mb-0"><i class="fas fa-calculator me-2"></i>Real-time Balance Calculator</h6>
                </div>
                <div class="card-body">
                    <form id="realtimeBalanceForm">
                        <div class="mb-3">
                            <label for="as_of_date" class="form-label text-white">As of Date:</label>
                            <input type="date" class="form-control" id="as_of_date" name="as_of_date" 
                                   value="{{ today.strftime('%Y-%m-%d') }}" 
                                   {% if customer.get_effective_end_date() %}max="{{ customer.get_effective_end_date().strftime('%Y-%m-%d') }}"{% endif %}
                                   required>
                            {% if customer.get_effective_end_date() %}
                            <small class="text-light">Max date: {{ customer.get_effective_end_date().strftime('%d-%m-%Y') }}</small>
                            {% endif %}
                        </div>
                        <button type="submit" class="btn btn-light btn-sm w-100">
                            <i class="fas fa-sync me-2"></i>Calculate Balance
                        </button>
                    </form>
                    
                    <!-- Results Display -->
                    <div id="realtimeResults" class="mt-3" style="display: none;">
                        <hr class="border-light">
                        <div class="text-center">
                            <h6 class="text-white">Balance as of <span id="resultDate"></span></h6>
                            <h4 class="text-white mb-2" id="resultBalance">₹0.00</h4>
                            <small class="text-light">
                                Principal: <span id="resultPrincipal">₹0.00</span><br>
                                Recorded Interest: <span id="resultRecordedInterest">₹0.00</span><br>
                                Accrued Interest: <span id="resultAccruedInterest">₹0.00</span><br>
                                <span id="additionalInfo"></span>
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Interactive Charts and Analytics -->
    <div class="row mb-4">
        <!-- Transaction Distribution Pie Chart -->
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-chart-pie me-2"></i>Transaction Distribution</h5>
                </div>
                <div class="card-body">
                    <canvas id="transactionPieChart" height="300"></canvas>
                </div>
            </div>
        </div>

        <!-- Balance Trend Line Chart -->
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-chart-line me-2"></i>Balance Trend</h5>
                </div>
                <div class="card-body">
                    <canvas id="balanceTrendChart" height="300"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Key Metrics Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card text-center bg-gradient-success text-white">
                <div class="card-body">
                    <i class="fas fa-arrow-up fa-2x mb-2"></i>
                    <h4 id="totalDeposits">₹0</h4>
                    <p class="mb-0">Total Deposits</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center bg-gradient-danger text-white">
                <div class="card-body">
                    <i class="fas fa-arrow-down fa-2x mb-2"></i>
                    <h4 id="totalWithdrawals">₹0</h4>
                    <p class="mb-0">Total Withdrawals</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center bg-gradient-warning text-white">
                <div class="card-body">
                    <i class="fas fa-percentage fa-2x mb-2"></i>
                    <h4 id="totalInterest">₹0</h4>
                    <p class="mb-0">Total Interest</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center bg-gradient-info text-white">
                <div class="card-body">
                    <i class="fas fa-calendar fa-2x mb-2"></i>
                    <h4 id="transactionCount">0</h4>
                    <p class="mb-0">Transactions</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Interest vs TDS Doughnut Chart -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-chart-doughnut me-2"></i>Interest vs TDS Breakdown</h5>
                </div>
                <div class="card-body">
                    <canvas id="interestTdsChart" height="300"></canvas>
                </div>
            </div>
        </div>
        
        <!-- Monthly Activity Bar Chart -->
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-chart-bar me-2"></i>Monthly Activity</h5>
                </div>
                <div class="card-body">
                    <canvas id="monthlyActivityChart" height="300"></canvas>
                </div>
            </div>
        </div>
    </div></div>

    <!-- Transaction History (Aggregated View) -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5><i class="fas fa-chart-line me-2"></i>Financial Summary</h5>
                    <div class="btn-group" role="group" aria-label="Period View">
                        <button type="button" class="btn btn-outline-primary active" data-period="quarterly">Quarterly</button>
                        <button type="button" class="btn btn-outline-primary" data-period="half_yearly">Half-Yearly</button>
                        <button type="button" class="btn btn-outline-primary" data-period="yearly">Yearly</button>
                    </div>
                </div>
                <div class="card-body">
                    <div id="quarterly_summary" class="period-summary-table">
                        {% if quarterly_summary %}
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th>Period</th>
                                        <th>Start Date</th>
                                        <th>End Date</th>
                                        <th class="text-end">Opening Balance</th>
                                        <th class="text-end">Total Paid</th>
                                        <th class="text-end">Total Repaid</th>
                                        <th class="text-end">Total Interest</th>
                                        <th class="text-end">Total TDS</th>
                                        <th class="text-end">Total Net Amount</th>
                                        <th class="text-end">Closing Balance</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for period in quarterly_summary %}
                                    <tr>
                                        <td>{{ period.period_name }}</td>
                                        <td>{{ period.start_date.strftime('%d-%m-%Y') }}</td>
                                        <td>{{ period.end_date.strftime('%d-%m-%Y') }}</td>
                                        <td class="text-end">{{ period.opening_balance | safe_currency }}</td>
                                        <td class="text-end text-success">{{ period.total_paid | safe_currency }}</td>
                                        <td class="text-end text-danger">{{ period.total_repaid | safe_currency }}</td>
                                        <td class="text-end">{{ period.total_interest | safe_currency }}</td>
                                        <td class="text-end">{{ period.total_tds | safe_currency }}</td>
                                        <td class="text-end text-primary">{{ period.total_net_amount | safe_currency }}</td>
                                        <td class="text-end"><strong>{{ period.closing_balance | safe_currency }}</strong></td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% else %}
                        <div class="text-center py-4">
                            <i class="fas fa-chart-pie fa-3x text-muted mb-3"></i>
                            <h5 class="text-muted">No quarterly data available.</h5>
                            <p class="text-muted">Add transactions to see financial summaries.</p>
                        </div>
                        {% endif %}
                    </div>

                    <div id="half_yearly_summary" class="period-summary-table" style="display: none;">
                        {% if half_yearly_summary %}
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th>Period</th>
                                        <th>Start Date</th>
                                        <th>End Date</th>
                                        <th class="text-end">Opening Balance</th>
                                        <th class="text-end">Total Paid</th>
                                        <th class="text-end">Total Repaid</th>
                                        <th class="text-end">Total Interest</th>
                                        <th class="text-end">Total TDS</th>
                                        <th class="text-end">Total Net Amount</th>
                                        <th class="text-end">Closing Balance</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for period in half_yearly_summary %}
                                    <tr>
                                        <td>{{ period.period_name }}</td>
                                        <td>{{ period.start_date.strftime('%d-%m-%Y') }}</td>
                                        <td>{{ period.end_date.strftime('%d-%m-%Y') }}</td>
                                        <td class="text-end">{{ period.opening_balance | safe_currency }}</td>
                                        <td class="text-end text-success">{{ period.total_paid | safe_currency }}</td>
                                        <td class="text-end text-danger">{{ period.total_repaid | safe_currency }}</td>
                                        <td class="text-end">{{ period.total_interest | safe_currency }}</td>
                                        <td class="text-end">{{ period.total_tds | safe_currency }}</td>
                                        <td class="text-end text-primary">{{ period.total_net_amount | safe_currency }}</td>
                                        <td class="text-end"><strong>{{ period.closing_balance | safe_currency }}</strong></td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% else %}
                        <div class="text-center py-4">
                            <i class="fas fa-chart-pie fa-3x text-muted mb-3"></i>
                            <h5 class="text-muted">No half-yearly data available.</h5>
                            <p class="text-muted">Add transactions to see financial summaries.</p>
                        </div>
                        {% endif %}
                    </div>

                    <div id="yearly_summary" class="period-summary-table" style="display: none;">
                        {% if yearly_summary %}
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th>Period</th>
                                        <th>Start Date</th>
                                        <th>End Date</th>
                                        <th class="text-end">Opening Balance</th>
                                        <th class="text-end">Total Paid</th>
                                        <th class="text-end">Total Repaid</th>
                                        <th class="text-end">Total Interest</th>
                                        <th class="text-end">Total TDS</th>
                                        <th class="text-end">Total Net Amount</th>
                                        <th class="text-end">Closing Balance</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for period in yearly_summary %}
                                    <tr>
                                        <td>{{ period.period_name }}</td>
                                        <td>{{ period.start_date.strftime('%d-%m-%Y') }}</td>
                                        <td>{{ period.end_date.strftime('%d-%m-%Y') }}</td>
                                        <td class="text-end">{{ period.opening_balance | safe_currency }}</td>
                                        <td class="text-end text-success">{{ period.total_paid | safe_currency }}</td>
                                        <td class="text-end text-danger">{{ period.total_repaid | safe_currency }}</td>
                                        <td class="text-end">{{ period.total_interest | safe_currency }}</td>
                                        <td class="text-end">{{ period.total_tds | safe_currency }}</td>
                                        <td class="text-end text-primary">{{ period.total_net_amount | safe_currency }}</td>
                                        <td class="text-end"><strong>{{ period.closing_balance | safe_currency }}</strong></td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% else %}
                        <div class="text-center py-4">
                            <i class="fas fa-chart-pie fa-3x text-muted mb-3"></i>
                            <h5 class="text-muted">No yearly data available.</h5>
                            <p class="text-muted">Add transactions to see financial summaries.</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Back Button -->
    <div class="row mt-4">
        <div class="col-12">
            <a href="{{ url_for('dashboard') }}" class="btn btn-secondary">
                <i class="fas fa-arrow-left me-2"></i>Back to Dashboard
            </a>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<!-- Chart.js Library -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>

<script>
$(document).ready(function() {
    // Transaction data from backend
    const transactions = [
        {% for transaction in transactions %}
        {
            date: '{{ transaction.date.strftime("%Y-%m-%d") if transaction.date else "" }}',
            amountPaid: {{ transaction.get_safe_amount_paid() }},
            amountRepaid: {{ transaction.get_safe_amount_repaid() }},
            balance: {{ transaction.get_safe_balance() }},
            interest: {{ transaction.get_safe_int_amount() }},
            tds: {{ transaction.get_safe_tds_amount() }},
            netAmount: {{ transaction.get_safe_net_amount() }}
        },
        {% endfor %}
    ];

    // Calculate metrics
    function calculateMetrics() {
        let totalDeposits = 0;
        let totalWithdrawals = 0;
        let totalInterest = 0;
        let totalTds = 0;
        
        transactions.forEach(txn => {
            totalDeposits += parseFloat(txn.amountPaid) || 0;
            totalWithdrawals += parseFloat(txn.amountRepaid) || 0;
            totalInterest += parseFloat(txn.interest) || 0;
            totalTds += parseFloat(txn.tds) || 0;
        });
        
        return {
            totalDeposits,
            totalWithdrawals,
            totalInterest,
            totalTds,
            transactionCount: transactions.length
        };
    }

    const metrics = calculateMetrics();

    // Update metric cards
    $('#totalDeposits').text('₹' + metrics.totalDeposits.toLocaleString('en-IN', {maximumFractionDigits: 2}));
    $('#totalWithdrawals').text('₹' + metrics.totalWithdrawals.toLocaleString('en-IN', {maximumFractionDigits: 2}));
    $('#totalInterest').text('₹' + metrics.totalInterest.toLocaleString('en-IN', {maximumFractionDigits: 2}));
    $('#transactionCount').text(metrics.transactionCount);

    // Transaction Distribution Pie Chart
    const ctx1 = document.getElementById('transactionPieChart').getContext('2d');
    new Chart(ctx1, {
        type: 'pie',
        data: {
            labels: ['Deposits', 'Withdrawals'],
            datasets: [{
                data: [metrics.totalDeposits, metrics.totalWithdrawals],
                backgroundColor: [
                    'rgba(34, 197, 94, 0.8)',
                    'rgba(239, 68, 68, 0.8)'
                ],
                borderColor: [
                    'rgba(34, 197, 94, 1)',
                    'rgba(239, 68, 68, 1)'
                ],
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const value = context.parsed;
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = ((value / total) * 100).toFixed(1);
                            return context.label + ': ₹' + value.toLocaleString('en-IN') + ' (' + percentage + '%)';
                        }
                    }
                }
            }
        }
    });

    // Balance Trend Line Chart
    const ctx2 = document.getElementById('balanceTrendChart').getContext('2d');
    const balanceData = transactions.map(txn => ({
        x: txn.date,
        y: parseFloat(txn.balance) || 0
    })).sort((a, b) => new Date(a.x) - new Date(b.x));

    new Chart(ctx2, {
        type: 'line',
        data: {
            datasets: [{
                label: 'Balance Trend',
                data: balanceData,
                borderColor: 'rgba(79, 70, 229, 1)',
                backgroundColor: 'rgba(79, 70, 229, 0.1)',
                borderWidth: 3,
                fill: true,
                tension: 0.4,
                pointBackgroundColor: 'rgba(79, 70, 229, 1)',
                pointBorderColor: '#fff',
                pointBorderWidth: 2,
                pointRadius: 6
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                x: {
                    type: 'time',
                    time: {
                        unit: 'day'
                    },
                    title: {
                        display: true,
                        text: 'Date'
                    }
                },
                y: {
                    title: {
                        display: true,
                        text: 'Balance (₹)'
                    },
                    ticks: {
                        callback: function(value) {
                            return '₹' + value.toLocaleString('en-IN');
                        }
                    }
                }
            },
            plugins: {
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return 'Balance: ₹' + context.parsed.y.toLocaleString('en-IN');
                        }
                    }
                }
            }
        }
    });

    // Interest vs TDS Doughnut Chart
    const ctx3 = document.getElementById('interestTdsChart').getContext('2d');
    const netInterest = metrics.totalInterest - metrics.totalTds;
    
    new Chart(ctx3, {
        type: 'doughnut',
        data: {
            labels: ['Net Interest', 'TDS Deducted'],
            datasets: [{
                data: [netInterest, metrics.totalTds],
                backgroundColor: [
                    'rgba(16, 185, 129, 0.8)',
                    'rgba(245, 158, 11, 0.8)'
                ],
                borderColor: [
                    'rgba(16, 185, 129, 1)',
                    'rgba(245, 158, 11, 1)'
                ],
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const value = context.parsed;
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                            return context.label + ': ₹' + value.toLocaleString('en-IN') + ' (' + percentage + '%)';
                        }
                    }
                }
            }
        }
    });

    // Monthly Activity Bar Chart
    const ctx4 = document.getElementById('monthlyActivityChart').getContext('2d');
    
    // Group transactions by month
    const monthlyData = {};
    transactions.forEach(txn => {
        if (txn.date) {
            const month = new Date(txn.date).toISOString().substr(0, 7); // YYYY-MM format
            if (!monthlyData[month]) {
                monthlyData[month] = { deposits: 0, withdrawals: 0 };
            }
            monthlyData[month].deposits += parseFloat(txn.amountPaid) || 0;
            monthlyData[month].withdrawals += parseFloat(txn.amountRepaid) || 0;
        }
    });

    const months = Object.keys(monthlyData).sort();
    const monthlyDeposits = months.map(month => monthlyData[month].deposits);
    const monthlyWithdrawals = months.map(month => monthlyData[month].withdrawals);

    new Chart(ctx4, {
        type: 'bar',
        data: {
            labels: months.map(month => {
                const date = new Date(month + '-01');
                return date.toLocaleDateString('en-IN', { year: 'numeric', month: 'short' });
            }),
            datasets: [
                {
                    label: 'Deposits',
                    data: monthlyDeposits,
                    backgroundColor: 'rgba(34, 197, 94, 0.8)',
                    borderColor: 'rgba(34, 197, 94, 1)',
                    borderWidth: 1
                },
                {
                    label: 'Withdrawals',
                    data: monthlyWithdrawals,
                    backgroundColor: 'rgba(239, 68, 68, 0.8)',
                    borderColor: 'rgba(239, 68, 68, 1)',
                    borderWidth: 1
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Amount (₹)'
                    },
                    ticks: {
                        callback: function(value) {
                            return '₹' + value.toLocaleString('en-IN');
                        }
                    }
                },
                x: {
                    title: {
                        display: true,
                        text: 'Month'
                    }
                }
            },
            plugins: {
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return context.dataset.label + ': ₹' + context.parsed.y.toLocaleString('en-IN');
                        }
                    }
                }
            }
        }
    });

    // Handle period view selection
    $('.btn-group button').on('click', function() {
        // Remove active class from all buttons
        $('.btn-group button').removeClass('active');
        // Add active class to the clicked button
        $(this).addClass('active');

        // Hide all summary tables
        $('.period-summary-table').hide();

        // Show the selected summary table
        const periodType = $(this).data('period');
        $('#' + periodType + '_summary').show();
    });

    // Initialize DataTables for each summary table (if they exist)
    $('.period-summary-table table').each(function() {
        if (!$.fn.DataTable.isDataTable(this)) {
            $(this).DataTable({
                "paging": false,
                "searching": false,
                "info": false,
                "ordering": false,
                "responsive": true,
                "columnDefs": [
                    {
                        "targets": [3, 4, 5, 6, 7, 8, 9],
                        "className": "text-end"
                    }
                ]
            });
        }
    });

    // Animate metric cards on load
    $('.card').each(function(index) {
        $(this).css({
            'animation': 'fadeInUp 0.6s ease forwards',
            'animation-delay': (index * 0.1) + 's'
        });
    });

    // Real-time balance calculation
    $('#realtimeBalanceForm').on('submit', function(e) {
        e.preventDefault();
        
        const asOfDate = $('#as_of_date').val();
        if (!asOfDate) {
            alert('Please select a date');
            return;
        }
        
        // Show loading state
        const submitBtn = $(this).find('button[type="submit"]');
        const originalText = submitBtn.html();
        submitBtn.html('<i class="fas fa-spinner fa-spin me-2"></i>Calculating...').prop('disabled', true);
        
        $.ajax({
            url: '/calculate_realtime_balance/{{ customer.id }}',
            method: 'POST',
            data: {
                as_of_date: asOfDate
            },
            success: function(response) {
                if (response.success) {
                    // Update results
                    $('#resultDate').text(response.as_of_date);
                    $('#resultBalance').text('₹' + parseFloat(response.balance).toLocaleString('en-IN', {maximumFractionDigits: 2}));
                    $('#resultPrincipal').text('₹' + parseFloat(response.principal).toLocaleString('en-IN', {maximumFractionDigits: 2}));
                    $('#resultRecordedInterest').text('₹' + parseFloat(response.recorded_interest).toLocaleString('en-IN', {maximumFractionDigits: 2}));
                    $('#resultAccruedInterest').text('₹' + parseFloat(response.accrued_interest).toLocaleString('en-IN', {maximumFractionDigits: 2}));
                    
                    // Additional info
                    let additionalInfo = '';
                    if (response.days_calculated > 0) {
                        additionalInfo = `(${response.days_calculated} days @ ${response.interest_type} interest)`;
                    } else {
                        additionalInfo = '(No additional interest calculated)';
                    }
                    $('#additionalInfo').text(additionalInfo);
                    
                    // Show results
                    $('#realtimeResults').slideDown();
                } else {
                    alert('Error: ' + response.error);
                }
            },
            error: function(xhr, status, error) {
                alert('Error calculating balance: ' + error);
            },
            complete: function() {
                // Reset button
                submitBtn.html(originalText).prop('disabled', false);
            }
        });
    });
});
</script>

<style>
@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(30px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.bg-gradient-success {
    background: linear-gradient(135deg, #10b981, #34d399) !important;
}

.bg-gradient-danger {
    background: linear-gradient(135deg, #ef4444, #f87171) !important;
}

.bg-gradient-warning {
    background: linear-gradient(135deg, #f59e0b, #fbbf24) !important;
}

.bg-gradient-info {
    background: linear-gradient(135deg, #3b82f6, #60a5fa) !important;
}

.card {
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    transition: all 0.3s ease;
}

.card:hover {
    transform: translateY(-2px);
    box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
}
</style>
{% endblock %}
